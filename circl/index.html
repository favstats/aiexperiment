<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Circl Â· Feed</title>
  
  <!-- Choices.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --circl-blue: #1877F2;
      --circl-blue-hover: #166FE5;
      --circl-teal: #00A3A3;
      --circl-bg: #F0F2F5;
      --circl-white: #FFFFFF;
      --circl-gray-100: #F5F6F7;
      --circl-gray-200: #E4E6EB;
      --circl-gray-300: #B0B3B8;
      --circl-gray-400: #8A8D91;
      --circl-gray-500: #606770;
      --circl-gray-600: #444950;
      --circl-text-primary: #050505;
      --circl-text-secondary: #65676B;
      --circl-green: #42B72A;
      --circl-red: #FA383E;
      --circl-orange: #F5A623;
      --circl-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      --circl-shadow-lg: 0 2px 12px rgba(0, 0, 0, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--circl-bg);
      color: var(--circl-text-primary);
      min-height: 100vh;
    }

    /* ============================================
       TOP HEADER BAR (Facebook-style)
       ============================================ */
    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: var(--circl-white);
      box-shadow: var(--circl-shadow);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .circl-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .circl-logo-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .circl-logo-icon svg {
      width: 40px;
      height: 40px;
    }

    .circl-logo-text {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--circl-blue), var(--circl-teal));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }

    .header-search {
      position: relative;
      width: 240px;
    }

    .header-search i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--circl-gray-400);
    }

    .header-search input {
      width: 100%;
      background: var(--circl-gray-200);
      border: none;
      border-radius: 20px;
      padding: 10px 16px 10px 40px;
      font-size: 15px;
      color: var(--circl-text-primary);
      outline: none;
      transition: all 0.2s;
    }

    .header-search input:focus {
      background: var(--circl-white);
      box-shadow: 0 0 0 2px var(--circl-blue);
    }

    .header-search input::placeholder {
      color: var(--circl-gray-400);
    }

    .header-center {
      display: flex;
      gap: 8px;
    }

    .header-nav-item {
      width: 110px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      color: var(--circl-gray-400);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .header-nav-item i {
      font-size: 24px;
    }

    .header-nav-item:hover {
      background: var(--circl-gray-100);
    }

    .header-nav-item.active {
      color: var(--circl-blue);
    }

    .header-nav-item.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--circl-blue);
      border-radius: 3px 3px 0 0;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--circl-gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--circl-text-primary);
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-size: 18px;
    }

    .header-icon-btn:hover {
      background: var(--circl-gray-300);
    }

    .header-profile {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--circl-blue), var(--circl-teal));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
    }

    /* ============================================
       THREE COLUMN LAYOUT
       ============================================ */
    .app-container {
      display: flex;
      width: 100%;
      min-height: 100vh;
      padding-top: 56px;
    }

    /* LEFT SIDEBAR */
    .sidebar-left {
      width: 280px;
      flex-shrink: 0;
      padding: 16px 8px;
      position: sticky;
      top: 56px;
      height: calc(100vh - 56px);
      overflow-y: auto;
      background: var(--circl-bg);
    }

    .sidebar-nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 8px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      color: var(--circl-text-primary);
      text-decoration: none;
      transition: background 0.2s;
      cursor: pointer;
    }

    .sidebar-nav-item:hover {
      background: var(--circl-gray-200);
    }

    .sidebar-nav-item.active {
      background: var(--circl-gray-200);
      color: var(--circl-blue);
    }

    .sidebar-nav-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--circl-gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .sidebar-nav-item.active .sidebar-nav-icon {
      background: linear-gradient(135deg, var(--circl-blue), var(--circl-teal));
      color: white;
    }

    .sidebar-divider {
      height: 1px;
      background: var(--circl-gray-200);
      margin: 8px 0;
    }

    .sidebar-section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--circl-text-secondary);
      padding: 12px 8px 8px;
    }

    /* MAIN FEED */
    .main-feed {
      flex: 1;
      max-width: 680px;
      min-height: 100vh;
      padding: 24px 16px;
      margin: 0 auto;
    }

    /* Create Post Box */
    .create-post-box {
      background: var(--circl-white);
      border-radius: 8px;
      box-shadow: var(--circl-shadow);
      padding: 12px 16px;
      margin-bottom: 16px;
    }

    .create-post-top {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .create-post-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--circl-blue), var(--circl-teal));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    .create-post-input {
      flex: 1;
      background: var(--circl-gray-100);
      border: none;
      border-radius: 20px;
      padding: 10px 16px;
      font-size: 17px;
      color: var(--circl-text-secondary);
      cursor: pointer;
      transition: background 0.2s;
    }

    .create-post-input:hover {
      background: var(--circl-gray-200);
    }

    .create-post-divider {
      height: 1px;
      background: var(--circl-gray-200);
      margin: 12px 0;
    }

    .create-post-actions {
      display: flex;
      justify-content: space-around;
    }

    .create-post-action {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 24px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      color: var(--circl-text-secondary);
      cursor: pointer;
      transition: background 0.2s;
    }

    .create-post-action:hover {
      background: var(--circl-gray-100);
    }

    .create-post-action i.fa-video {
      color: #F02849;
    }

    .create-post-action i.fa-images {
      color: #45BD62;
    }

    .create-post-action i.fa-face-smile {
      color: #F7B928;
    }

    /* Post Card (Facebook Style) */
    .post {
      background: var(--circl-white);
      border-radius: 8px;
      box-shadow: var(--circl-shadow);
      margin-bottom: 16px;
      overflow: hidden;
    }

    .post:hover {
      box-shadow: var(--circl-shadow-lg);
    }

    .post-header-section {
      padding: 12px 16px 0;
    }

    .post-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .post-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--circl-blue), var(--circl-teal));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      flex-shrink: 0;
    }

    .post.placeholder-post .post-avatar {
      background: linear-gradient(135deg, #6b7280, #4b5563);
    }

    .post-header-info {
      flex: 1;
    }

    .post-name-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .post-name {
      font-weight: 600;
      font-size: 15px;
      color: var(--circl-text-primary);
    }

    .post-verified {
      color: var(--circl-blue);
      font-size: 14px;
    }

    .ai-badge {
      background: linear-gradient(135deg, var(--circl-blue), var(--circl-teal));
      color: white;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .ai-badge.hidden {
      display: none;
    }

    .post-meta {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      color: var(--circl-text-secondary);
      margin-top: 2px;
    }

    .post-meta i {
      font-size: 12px;
    }

    .post-more {
      color: var(--circl-gray-400);
      padding: 8px;
      margin: -8px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
    }

    .post-more:hover {
      background: var(--circl-gray-100);
      color: var(--circl-text-primary);
    }

    .post-content {
      padding: 12px 16px;
    }

    .post-text {
      font-size: 15px;
      line-height: 1.5;
      color: var(--circl-text-primary);
      white-space: pre-wrap;
    }

    .post-hashtag {
      color: var(--circl-blue);
      font-weight: 500;
    }

    /* Image carousel */
    .post-media {
      position: relative;
      background: var(--circl-gray-100);
    }

    .carousel-track {
      display: flex;
      transition: transform 0.3s ease;
    }

    .carousel-slide {
      min-width: 100%;
    }

    .carousel-slide img {
      width: 100%;
      display: block;
      object-fit: contain;
    }

    .carousel-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      background: var(--circl-white);
      box-shadow: var(--circl-shadow-lg);
      border: none;
      border-radius: 50%;
      color: var(--circl-text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .carousel-nav:hover {
      background: var(--circl-gray-100);
      transform: translateY(-50%) scale(1.05);
    }

    .carousel-nav.prev { left: 12px; }
    .carousel-nav.next { right: 12px; }

    .carousel-counter {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
      z-index: 10;
    }

    .carousel-dots {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 6px;
      padding: 6px 10px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 12px;
    }

    .carousel-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .carousel-dot.active {
      background: #fff;
      transform: scale(1.2);
    }

    /* Post reactions bar */
    .post-reactions-bar {
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--circl-gray-200);
    }

    .post-reactions-count {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      color: var(--circl-text-secondary);
    }

    .reaction-icons {
      display: flex;
      margin-right: 4px;
    }

    .reaction-icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
      margin-left: -4px;
      border: 2px solid var(--circl-white);
    }

    .reaction-icon:first-child { margin-left: 0; }
    .reaction-icon.like { background: var(--circl-blue); }
    .reaction-icon.love { background: #F33E58; }
    .reaction-icon.wow { background: #F7B928; }

    .post-engagement-count {
      font-size: 15px;
      color: var(--circl-text-secondary);
    }

    /* Post Actions */
    .post-actions {
      display: flex;
      padding: 4px 16px;
    }

    .post-action {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 4px;
      border-radius: 4px;
      color: var(--circl-text-secondary);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .post-action i {
      font-size: 20px;
    }

    .post-action:hover {
      background: var(--circl-gray-100);
    }

    .post-action.liked {
      color: var(--circl-blue);
    }

    .post-action.liked i.far.fa-thumbs-up::before {
      content: "\f164";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
    }

    .post-action.shared {
      color: var(--circl-teal);
      animation: shareFlash 0.3s ease;
    }

    @keyframes shareFlash {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* RIGHT SIDEBAR - FILTERS */
    .sidebar-right {
      width: 360px;
      flex-shrink: 0;
      padding: 24px 16px;
      position: sticky;
      top: 56px;
      height: calc(100vh - 56px);
      overflow-y: auto;
    }

    .filter-card {
      background: var(--circl-white);
      border-radius: 8px;
      box-shadow: var(--circl-shadow);
      margin-bottom: 16px;
      overflow: visible;
    }

    .filter-card-header {
      padding: 16px;
      font-size: 17px;
      font-weight: 700;
      color: var(--circl-text-primary);
      border-bottom: 1px solid var(--circl-gray-200);
    }

    .filter-group {
      padding: 12px 16px;
    }

    .filter-label {
      font-size: 13px;
      color: var(--circl-text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .filter-info {
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(24, 119, 242, 0.1), rgba(0, 163, 163, 0.1));
      border-top: 1px solid var(--circl-gray-200);
    }

    .filter-info-text {
      font-size: 15px;
      color: var(--circl-blue);
      font-weight: 600;
    }

    .filter-info-sub {
      font-size: 13px;
      color: var(--circl-text-secondary);
      margin-top: 4px;
    }

    /* Choices.js overrides for light theme */
    .choices {
      margin-bottom: 0;
    }

    .choices__inner {
      background: var(--circl-gray-100) !important;
      border: 1px solid var(--circl-gray-200) !important;
      border-radius: 8px !important;
      min-height: 42px !important;
      padding: 4px 8px !important;
    }

    .choices__input {
      background: transparent !important;
      color: var(--circl-text-primary) !important;
    }

    .choices__list--single .choices__item {
      color: var(--circl-text-primary) !important;
    }

    .choices__list--dropdown {
      background: var(--circl-white) !important;
      border: 1px solid var(--circl-gray-200) !important;
      border-radius: 8px !important;
      box-shadow: var(--circl-shadow-lg) !important;
      z-index: 9999 !important;
    }

    .choices__list--dropdown .choices__item {
      color: var(--circl-text-primary) !important;
      padding: 12px 16px !important;
    }

    .choices__list--dropdown .choices__item--selectable.is-highlighted {
      background: var(--circl-gray-100) !important;
    }

    .choices[data-type*="select-one"]::after {
      border-color: var(--circl-gray-400) transparent transparent transparent !important;
    }

    /* Generate Feed Button */
    .generate-feed-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--circl-blue), var(--circl-teal));
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .generate-feed-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 15px rgba(24, 119, 242, 0.4);
    }

    .generate-feed-btn:active {
      transform: scale(0.98);
    }

    /* Mixed Feed Mode Indicator */
    .feed-mode-indicator {
      background: linear-gradient(135deg, var(--circl-blue), var(--circl-teal));
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
      font-weight: 600;
    }

    .feed-mode-indicator button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }

    .feed-mode-indicator button:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Toggle buttons row */
    .toggle-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .toggle-btn {
      flex: 1;
      background: var(--circl-gray-100);
      border: 1px solid var(--circl-gray-200);
      color: var(--circl-text-secondary);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .toggle-btn:hover {
      background: var(--circl-gray-200);
      color: var(--circl-text-primary);
    }

    .toggle-btn.active {
      background: var(--circl-blue);
      border-color: var(--circl-blue);
      color: white;
    }

    /* Sponsored Section */
    .sponsored-item {
      display: flex;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .sponsored-item:hover {
      background: var(--circl-gray-100);
    }

    .sponsored-item img {
      width: 120px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
    }

    .sponsored-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .sponsored-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--circl-text-primary);
      margin-bottom: 4px;
    }

    .sponsored-site {
      font-size: 12px;
      color: var(--circl-text-secondary);
    }

    /* Contacts Section */
    .contacts-header-icons {
      display: flex;
      gap: 16px;
      color: var(--circl-text-secondary);
      font-size: 14px;
    }

    .contacts-header-icons i {
      cursor: pointer;
      transition: color 0.2s;
    }

    .contacts-header-icons i:hover {
      color: var(--circl-blue);
    }

    .contacts-card .filter-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .contact-list {
      padding: 8px 0;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }

    .contact-item:hover {
      background: var(--circl-gray-100);
    }

    .contact-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }

    .contact-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--circl-text-primary);
      flex: 1;
    }

    .online-dot {
      width: 10px;
      height: 10px;
      background: var(--circl-green);
      border-radius: 50%;
      border: 2px solid var(--circl-white);
    }

    .away-dot {
      width: 10px;
      height: 10px;
      background: var(--circl-orange);
      border-radius: 50%;
      border: 2px solid var(--circl-white);
    }

    /* Number input row */
    .input-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .input-label {
      font-size: 14px;
      color: var(--circl-text-primary);
    }

    .number-input {
      width: 70px;
      background: var(--circl-gray-100);
      border: 1px solid var(--circl-gray-200);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      color: var(--circl-text-primary);
      text-align: center;
      outline: none;
      transition: border-color 0.2s;
    }

    .number-input:focus {
      border-color: var(--circl-blue);
    }

    /* ============================================
       STATES
       ============================================ */
    .hidden { display: none !important; }

    .loading, .no-results {
      padding: 60px;
      text-align: center;
      color: var(--circl-text-secondary);
      background: var(--circl-white);
      border-radius: 8px;
      box-shadow: var(--circl-shadow);
    }

    .loading i {
      font-size: 32px;
      color: var(--circl-blue);
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    .no-results i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Scrollbar for light theme */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--circl-gray-100); }
    ::-webkit-scrollbar-thumb { background: var(--circl-gray-300); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--circl-gray-400); }

    /* ============================================
       QUALITY CONTROL MODE
       ============================================ */
    .qc-container {
      flex: 1;
      max-width: 1400px;
      min-height: 100vh;
      padding: 24px;
      margin: 0 auto;
      display: none;
    }

    .qc-container.active {
      display: block;
    }

    .main-feed.hidden {
      display: none;
    }

    .sidebar-right.hidden {
      display: none !important;
    }

    .qc-header {
      background: var(--circl-white);
      border-radius: 8px;
      box-shadow: var(--circl-shadow);
      padding: 16px 20px;
      margin-bottom: 16px;
    }

    .qc-header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .qc-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--circl-text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .qc-title i {
      color: var(--circl-blue);
    }

    .qc-progress {
      font-size: 14px;
      color: var(--circl-text-secondary);
    }

    .qc-coder-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .qc-coder-input {
      background: var(--circl-gray-100);
      border: 1px solid var(--circl-gray-200);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      color: var(--circl-text-primary);
      width: 150px;
      outline: none;
    }

    .qc-coder-input:focus {
      border-color: var(--circl-blue);
    }

    .qc-filter-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--circl-text-secondary);
    }

    .qc-filter-toggle input[type="checkbox"] {
      accent-color: var(--circl-blue);
    }

    .qc-content {
      display: flex;
      gap: 16px;
    }

    .qc-image-panel {
      flex: 1;
      background: var(--circl-white);
      border-radius: 8px;
      box-shadow: var(--circl-shadow);
      padding: 20px;
    }

    .qc-image-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .qc-nav-btn {
      background: var(--circl-gray-100);
      border: 1px solid var(--circl-gray-200);
      color: var(--circl-text-primary);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .qc-nav-btn:hover:not(:disabled) {
      background: var(--circl-gray-200);
    }

    .qc-nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .qc-image-counter {
      font-size: 14px;
      color: var(--circl-text-secondary);
    }

    .qc-image-wrapper {
      background: var(--circl-gray-100);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .qc-image-wrapper img {
      width: 100%;
      display: block;
    }

    .qc-condition-info {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .qc-condition-tag {
      background: var(--circl-gray-100);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      color: var(--circl-text-secondary);
    }

    .qc-condition-tag.highlight {
      background: linear-gradient(135deg, var(--circl-blue), var(--circl-teal));
      color: white;
    }

    .qc-condition-tag.ideology-tag {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5px;
    }

    .qc-condition-tag.ideology-tag.left {
      background: #E53935;
      color: white;
    }

    .qc-condition-tag.ideology-tag.right {
      background: #1E88E5;
      color: white;
    }

    .qc-condition-tag.ideology-tag.neutral {
      background: #9E9E9E;
      color: white;
    }

    .qc-condition-tag.outgroup-tag {
      background: #FFE0B2;
      color: #E65100;
      font-weight: 500;
      border: 1px solid #FFCC80;
    }

    /* QC Form Panel */
    .qc-form-panel {
      width: 400px;
      background: var(--circl-white);
      border-radius: 8px;
      box-shadow: var(--circl-shadow);
      padding: 20px;
      overflow-y: auto;
      max-height: calc(100vh - 160px);
    }

    .qc-form-section {
      margin-bottom: 24px;
    }

    .qc-form-section-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--circl-text-primary);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .qc-field {
      margin-bottom: 16px;
    }

    .qc-field-label {
      font-size: 14px;
      color: var(--circl-text-primary);
      margin-bottom: 8px;
      display: block;
    }

    .qc-radio-group {
      display: flex;
      gap: 8px;
    }

    .qc-radio-option {
      flex: 1;
      position: relative;
    }

    .qc-radio-option input {
      position: absolute;
      opacity: 0;
    }

    .qc-radio-option label {
      display: block;
      text-align: center;
      padding: 10px;
      background: var(--circl-gray-100);
      border: 1px solid var(--circl-gray-200);
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .qc-radio-option input:checked + label {
      background: var(--circl-blue);
      border-color: var(--circl-blue);
      color: white;
    }

    .qc-radio-option label:hover {
      border-color: var(--circl-blue);
    }

    /* Star Rating */
    .qc-star-rating {
      display: flex;
      gap: 4px;
    }

    .qc-star {
      font-size: 24px;
      color: var(--circl-gray-300);
      cursor: pointer;
      transition: color 0.15s;
    }

    .qc-star.active,
    .qc-star.hover {
      color: var(--circl-orange);
    }

    /* Range Slider */
    .qc-range-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .qc-range {
      flex: 1;
      -webkit-appearance: none;
      background: var(--circl-gray-200);
      height: 6px;
      border-radius: 3px;
      outline: none;
    }

    .qc-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--circl-blue);
      cursor: pointer;
    }

    .qc-range-value {
      min-width: 30px;
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      color: var(--circl-text-primary);
    }

    /* Valence Scale */
    .qc-valence-scale {
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }

    .qc-valence-option {
      flex: 1;
      position: relative;
    }

    .qc-valence-option input {
      position: absolute;
      opacity: 0;
    }

    .qc-valence-option label {
      display: block;
      text-align: center;
      padding: 8px 4px;
      background: var(--circl-gray-100);
      border: 1px solid var(--circl-gray-200);
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }

    .qc-valence-option:first-child input:checked + label { background: #dc2626; border-color: #dc2626; color: white; }
    .qc-valence-option:nth-child(2) input:checked + label { background: #f97316; border-color: #f97316; color: white; }
    .qc-valence-option:nth-child(3) input:checked + label { background: #6b7280; border-color: #6b7280; color: white; }
    .qc-valence-option:nth-child(4) input:checked + label { background: #22c55e; border-color: #22c55e; color: white; }
    .qc-valence-option:last-child input:checked + label { background: #16a34a; border-color: #16a34a; color: white; }

    /* Notes */
    .qc-notes {
      width: 100%;
      background: var(--circl-gray-100);
      border: 1px solid var(--circl-gray-200);
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      color: var(--circl-text-primary);
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
      outline: none;
    }

    .qc-notes:focus {
      border-color: var(--circl-blue);
    }

    /* Submit Button */
    .qc-submit-btn {
      width: 100%;
      background: var(--circl-green);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 14px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .qc-submit-btn:hover {
      background: #3a9e24;
    }

    .qc-submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .qc-status {
      text-align: center;
      margin-top: 12px;
      font-size: 14px;
    }

    .qc-status.success {
      color: var(--circl-green);
    }

    .qc-status.error {
      color: var(--circl-red);
    }

    /* Coded indicator */
    .qc-coded-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--circl-green);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    /* ============================================
       COMMENT MODAL (Facebook-style Dialog)
       ============================================ */
    .comment-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(4px);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .comment-modal-overlay.active {
      display: flex;
    }

    .comment-modal {
      background: var(--circl-white);
      border-radius: 8px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 550px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .comment-modal-header {
      padding: 16px;
      border-bottom: 1px solid var(--circl-gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .comment-modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--circl-text-primary);
    }

    .comment-modal-close {
      position: absolute;
      right: 16px;
      background: var(--circl-gray-200);
      border: none;
      color: var(--circl-text-secondary);
      font-size: 20px;
      cursor: pointer;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .comment-modal-close:hover {
      background: var(--circl-gray-300);
      color: var(--circl-text-primary);
    }

    .comment-modal-content {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }

    .comment-post-preview {
      padding: 12px;
      background: var(--circl-gray-100);
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .comment-post-preview-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .comment-post-preview-name {
      font-weight: 600;
      font-size: 15px;
      color: var(--circl-text-primary);
    }

    .comment-post-preview-handle {
      color: var(--circl-text-secondary);
      font-size: 15px;
    }

    .comment-post-preview-text {
      font-size: 15px;
      color: var(--circl-text-primary);
      line-height: 1.4;
    }

    .comment-textarea {
      width: 100%;
      background: var(--circl-gray-100);
      border: 1px solid var(--circl-gray-200);
      border-radius: 8px;
      padding: 12px;
      font-size: 15px;
      color: var(--circl-text-primary);
      resize: vertical;
      min-height: 120px;
      font-family: inherit;
      outline: none;
      margin-bottom: 16px;
    }

    .comment-textarea:focus {
      border-color: var(--circl-blue);
    }

    .comment-textarea::placeholder {
      color: var(--circl-text-secondary);
    }

    .comment-modal-footer {
      padding: 16px;
      border-top: 1px solid var(--circl-gray-200);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .comment-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .comment-btn-cancel {
      background: var(--circl-gray-200);
      color: var(--circl-text-primary);
    }

    .comment-btn-cancel:hover {
      background: var(--circl-gray-300);
    }

    .comment-btn-submit {
      background: var(--circl-blue);
      color: white;
    }

    .comment-btn-submit:hover {
      background: var(--circl-blue-hover);
    }

    .comment-btn-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Reaction status notification */
    .reaction-status {
      position: fixed;
      top: 80px;
      right: 20px;
      background: var(--circl-white);
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 14px;
      color: var(--circl-text-primary);
      z-index: 10001;
      display: none;
      align-items: center;
      gap: 8px;
      box-shadow: var(--circl-shadow-lg);
    }

    .reaction-status.active {
      display: flex;
    }

    .reaction-status.success {
      border-left: 4px solid var(--circl-green);
    }

    .reaction-status.error {
      border-left: 4px solid var(--circl-red);
      color: var(--circl-red);
    }

    /* Responsive */
    @media (max-width: 1400px) {
      .sidebar-right { width: 320px; }
    }

    @media (max-width: 1200px) {
      .sidebar-right { display: none; }
      .main-feed { max-width: 100%; }
    }

    @media (max-width: 900px) {
      .sidebar-left { width: 72px; padding: 8px 4px; }
      .sidebar-nav-item { padding: 10px; justify-content: center; }
      .sidebar-nav-item span { display: none; }
      .sidebar-section-title { display: none; }
      .header-center { display: none; }
      .main-feed { padding: 16px 12px; }
    }

    @media (max-width: 768px) {
      .sidebar-left { display: none; }
      .header-search { width: 180px; }
      .circl-logo-text { display: none; }
      .main-feed { padding: 12px 8px; }
      .create-post-box { padding: 10px 12px; }
      .create-post-action span { display: none; }
      .post-header-section { padding: 10px 12px 0; }
      .post-content { padding: 10px 12px; }
      .post-actions { padding: 4px 8px; }
      .post-action { font-size: 14px; padding: 10px 4px; }
      .post-action span { display: none; }
      .post-reactions-bar { padding: 8px 12px; }
      .qc-content { flex-direction: column; }
      .qc-form-panel { width: 100%; max-height: none; }
    }

    @media (max-width: 480px) {
      .header-search { display: none; }
      .header-right { gap: 4px; }
      .header-icon-btn { width: 36px; height: 36px; font-size: 16px; }
      .header-profile { width: 36px; height: 36px; font-size: 12px; }
      .circl-logo-icon { width: 36px; height: 36px; }
      .top-header { height: 52px; padding: 0 8px; }
      .app-container { padding-top: 52px; }
      .main-feed { padding: 8px 4px; }
      .create-post-box { border-radius: 0; margin-bottom: 8px; }
      .post { border-radius: 0; margin-bottom: 8px; }
      .post-avatar { width: 36px; height: 36px; font-size: 12px; }
      .post-name { font-size: 14px; }
      .post-meta { font-size: 12px; }
      .post-text { font-size: 14px; }
      .carousel-nav { width: 32px; height: 32px; }
      .carousel-counter { font-size: 11px; padding: 3px 8px; }
      .filter-card { border-radius: 0; }
    }

    /* Mobile bottom navigation */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: var(--circl-white);
      box-shadow: 0 -1px 4px rgba(0,0,0,0.1);
      z-index: 1000;
      justify-content: space-around;
      align-items: center;
      padding: 0 8px;
    }

    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      color: var(--circl-gray-400);
      font-size: 10px;
      text-decoration: none;
      cursor: pointer;
      transition: color 0.2s;
    }

    .mobile-nav-item i { font-size: 22px; margin-bottom: 2px; }
    .mobile-nav-item.active { color: var(--circl-blue); }

    @media (max-width: 768px) {
      .mobile-nav { display: flex; }
      .app-container { padding-bottom: 56px; }
    }

    /* ============================================
       EXPERIENCE MODE STYLES
       ============================================ */
    .experience-container {
      display: none;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .experience-container.active {
      display: block;
    }

    .experience-survey {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: calc(100vh - 120px);
      padding: 20px;
    }

    .experience-survey-card {
      background: var(--circl-white);
      border-radius: 16px;
      box-shadow: var(--circl-shadow-lg);
      padding: 40px;
      max-width: 600px;
      width: 100%;
      animation: slideUp 0.4s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .experience-survey-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .experience-logo {
      margin-bottom: 16px;
    }

    .experience-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--circl-text-primary);
      margin-bottom: 8px;
    }

    .experience-subtitle {
      font-size: 15px;
      color: var(--circl-text-secondary);
    }

    .experience-form {
      display: flex;
      flex-direction: column;
      gap: 28px;
    }

    .experience-field {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .experience-label {
      font-size: 16px;
      font-weight: 600;
      color: var(--circl-text-primary);
    }

    .experience-options {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .experience-option {
      flex: 1;
      min-width: 80px;
      padding: 14px 16px;
      border: 2px solid var(--circl-gray-200);
      border-radius: 12px;
      background: var(--circl-white);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      font-weight: 500;
      color: var(--circl-text-primary);
    }

    .experience-option i {
      font-size: 20px;
      color: var(--circl-gray-400);
      transition: color 0.2s;
    }

    .experience-option:hover {
      border-color: var(--circl-blue);
      background: rgba(24, 119, 242, 0.05);
    }

    .experience-option:hover i {
      color: var(--circl-blue);
    }

    .experience-option.selected {
      border-color: var(--circl-blue);
      background: rgba(24, 119, 242, 0.1);
    }

    .experience-option.selected i {
      color: var(--circl-blue);
    }

    .issue-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
    }

    .issue-btn {
      padding: 12px 10px;
    }

    .experience-slider-container {
      padding: 10px 0;
    }

    .experience-slider-labels {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 500;
    }

    .slider-label-left { color: #E74C3C; }
    .slider-label-center { color: var(--circl-gray-500); }
    .slider-label-right { color: #3498DB; }

    .experience-slider {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: linear-gradient(to right, #E74C3C 0%, #E74C3C 40%, #95A5A6 40%, #95A5A6 60%, #3498DB 60%, #3498DB 100%);
      border-radius: 4px;
      outline: none;
      cursor: pointer;
    }

    .experience-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--circl-white);
      border: 3px solid var(--circl-blue);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .experience-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }

    .experience-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--circl-white);
      border: 3px solid var(--circl-blue);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      cursor: pointer;
    }

    .experience-slider-ticks {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 11px;
      color: var(--circl-gray-400);
      padding: 0 2px;
    }

    .experience-slider-value {
      text-align: center;
      margin-top: 12px;
    }

    .ideology-badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .ideology-badge.left {
      background: rgba(231, 76, 60, 0.15);
      color: #C0392B;
    }

    .ideology-badge.neutral {
      background: rgba(149, 165, 166, 0.2);
      color: #7F8C8D;
    }

    .ideology-badge.right {
      background: rgba(52, 152, 219, 0.15);
      color: #2980B9;
    }

    .experience-submit {
      margin-top: 8px;
      padding: 16px 32px;
      background: linear-gradient(135deg, var(--circl-blue), var(--circl-teal));
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s;
      opacity: 0.5;
    }

    .experience-submit:not(:disabled) {
      opacity: 1;
    }

    .experience-submit:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(24, 119, 242, 0.35);
    }

    .experience-submit:disabled {
      cursor: not-allowed;
    }

    /* Experience Feed */
    .experience-feed {
      max-width: 680px;
      margin: 0 auto;
    }

    .experience-feed.hidden {
      display: none;
    }

    .experience-feed-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding: 16px 20px;
      background: var(--circl-white);
      border-radius: 12px;
      box-shadow: var(--circl-shadow);
    }

    .experience-back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--circl-gray-100);
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--circl-text-primary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .experience-back-btn:hover {
      background: var(--circl-gray-200);
    }

    .experience-feed-info {
      font-size: 13px;
      color: var(--circl-text-secondary);
    }

    .experience-toggle-labels {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--circl-gray-100);
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--circl-text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .experience-toggle-labels:hover {
      background: var(--circl-gray-200);
    }

    .experience-toggle-labels.active {
      background: var(--circl-blue);
      color: white;
    }

    .experience-posts-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .experience-posts-container .post {
      background: var(--circl-white);
      border-radius: 8px;
      box-shadow: var(--circl-shadow);
      overflow: hidden;
    }

    .experience-posts-container .post-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      gap: 10px;
    }

    .experience-posts-container .post-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      flex-shrink: 0;
    }

    .experience-posts-container .post-meta {
      flex: 1;
    }

    .experience-posts-container .post-author {
      font-weight: 600;
      font-size: 15px;
      color: var(--circl-text-primary);
    }

    .experience-posts-container .post-info {
      font-size: 13px;
      color: var(--circl-text-secondary);
    }

    .experience-posts-container .post-options {
      background: none;
      border: none;
      color: var(--circl-gray-400);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .experience-posts-container .post-options:hover {
      background: var(--circl-gray-100);
    }

    .experience-posts-container .post-content {
      padding: 0 16px 12px;
      font-size: 15px;
      line-height: 1.5;
      color: var(--circl-text-primary);
    }

    .experience-posts-container .post-image-container {
      position: relative;
      width: 100%;
    }

    .experience-posts-container .post-single-image {
      width: 100%;
      display: block;
    }

    .experience-posts-container .post-stats {
      display: flex;
      justify-content: space-between;
      padding: 10px 16px;
      font-size: 14px;
      color: var(--circl-text-secondary);
    }

    .experience-posts-container .post-reactions-count {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .experience-posts-container .reaction-icons {
      display: flex;
    }

    .experience-posts-container .reaction-icons i {
      font-size: 16px;
    }

    .experience-posts-container .reaction-icons i.fa-thumbs-up {
      color: var(--circl-blue);
    }

    .experience-posts-container .reaction-icons i.fa-heart {
      color: #E74C3C;
      margin-left: -4px;
    }

    .experience-posts-container .post-divider {
      height: 1px;
      background: var(--circl-gray-200);
      margin: 0 16px;
    }

    .experience-posts-container .post-actions {
      display: flex;
      padding: 4px 8px;
    }

    .experience-posts-container .post-action {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px;
      background: none;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      color: var(--circl-text-secondary);
      cursor: pointer;
      transition: background 0.2s;
    }

    .experience-posts-container .post-action:hover {
      background: var(--circl-gray-100);
    }

    .experience-posts-container .post-action i {
      font-size: 18px;
    }

    .experience-posts-container .post-action.liked {
      color: var(--circl-blue);
    }

    .experience-posts-container .post-action.liked i {
      color: var(--circl-blue);
    }

    .experience-posts-container .post-action.shared {
      color: var(--circl-teal);
    }

    .experience-posts-container .avatar-wrapper {
      width: 40px;
      height: 40px;
      flex-shrink: 0;
    }

    .experience-posts-container .post-avatar-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .experience-posts-container .post-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    .experience-posts-container .org-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--circl-blue), var(--circl-teal));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      flex-shrink: 0;
    }

    .experience-posts-container .org-logo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: contain;
      background: white;
      padding: 4px;
      border: 1px solid var(--circl-gray-200);
      flex-shrink: 0;
    }

    .comment-input-box {
      padding: 12px 16px;
      border-top: 1px solid var(--circl-gray-200);
    }

    .comment-input-wrapper {
      display: flex;
      gap: 8px;
    }

    .comment-input {
      flex: 1;
      padding: 10px 14px;
      border: none;
      background: var(--circl-gray-100);
      border-radius: 20px;
      font-size: 14px;
      outline: none;
      color: var(--circl-text-primary);
    }

    .comment-input::placeholder {
      color: var(--circl-gray-400);
    }

    .comment-input:focus {
      background: var(--circl-white);
      box-shadow: 0 0 0 2px var(--circl-blue);
      color: var(--circl-text-primary);
    }

    .comment-send {
      width: 36px;
      height: 36px;
      border: none;
      background: var(--circl-blue);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .comment-send:hover {
      background: var(--circl-blue-hover);
    }

    .comment-posted {
      text-align: center;
      color: var(--circl-green);
      font-size: 14px;
      font-weight: 500;
      padding: 8px;
    }

    .share-feedback {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      animation: fadeInOut 2s ease;
      z-index: 10;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    }

    /* Experience post indicator */
    .experience-ai-indicator {
      display: none;
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      z-index: 10;
      line-height: 1.4;
      text-align: right;
    }

    .experience-ai-indicator small {
      font-weight: 400;
      font-size: 10px;
      opacity: 0.85;
    }

    .experience-ai-indicator.tailored {
      background: linear-gradient(135deg, var(--circl-blue), var(--circl-teal));
    }

    .show-ai-labels .experience-ai-indicator {
      display: block;
    }

    @media (max-width: 768px) {
      .experience-survey-card {
        padding: 24px;
        margin: 10px;
      }
      
      .experience-title {
        font-size: 22px;
      }
      
      .experience-options {
        flex-direction: column;
      }
      
      .issue-options {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Debug Mode Toggle */
    .debug-toggle-field {
      padding-top: 8px;
      border-top: 1px solid var(--circl-gray-200);
    }

    .debug-toggle-label {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .debug-toggle-label input {
      display: none;
    }

    .debug-toggle-switch {
      width: 44px;
      height: 24px;
      background: var(--circl-gray-300);
      border-radius: 12px;
      position: relative;
      transition: background 0.3s;
    }

    .debug-toggle-switch::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .debug-toggle-label input:checked + .debug-toggle-switch {
      background: var(--circl-blue);
    }

    .debug-toggle-label input:checked + .debug-toggle-switch::after {
      transform: translateX(20px);
    }

    .debug-toggle-text {
      font-weight: 500;
      color: var(--circl-text-primary);
    }

    .debug-toggle-hint {
      font-size: 12px;
      color: var(--circl-text-secondary);
      margin-top: 6px;
      margin-left: 56px;
    }

    /* Debug Mode Indicators */
    .debug-mode .experience-ai-indicator {
      display: block !important;
    }

    .debug-mode .post-view-timer {
      display: block !important;
    }

    .debug-mode .experience-results-btn {
      display: block !important;
    }

    .post-view-timer {
      display: none;
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(0,0,0,0.8);
      color: #4ADE80;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-family: monospace;
      z-index: 10;
    }

    /* Results Button */
    .experience-results-btn {
      display: none;
      margin: 30px auto;
      padding: 16px 32px;
      background: linear-gradient(135deg, #10B981, #059669);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .debug-mode .experience-results-btn {
      display: block;
    }

    .experience-results-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
    }

    /* Results Modal */
    .results-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .results-modal.active {
      display: flex;
    }

    .results-card {
      background: var(--circl-white);
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow: auto;
      animation: slideUp 0.3s ease-out;
    }

    .results-header {
      padding: 24px;
      border-bottom: 1px solid var(--circl-gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .results-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--circl-text-primary);
    }

    .results-close {
      width: 36px;
      height: 36px;
      border: none;
      background: var(--circl-gray-100);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--circl-text-secondary);
    }

    .results-close:hover {
      background: var(--circl-gray-200);
    }

    .results-content {
      padding: 24px;
    }

    .results-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--circl-gray-100);
      border-radius: 12px;
      margin-bottom: 12px;
    }

    .results-rank {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--circl-blue), var(--circl-teal));
      color: white;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .results-item:nth-child(1) .results-rank { background: linear-gradient(135deg, #F59E0B, #D97706); }
    .results-item:nth-child(2) .results-rank { background: linear-gradient(135deg, #9CA3AF, #6B7280); }
    .results-item:nth-child(3) .results-rank { background: linear-gradient(135deg, #CD7F32, #A0522D); }

    .results-info {
      flex: 1;
    }

    .results-author {
      font-weight: 600;
      color: var(--circl-text-primary);
      margin-bottom: 4px;
    }

    .results-type {
      font-size: 12px;
      color: var(--circl-text-secondary);
    }

    .results-type.ai-tailored {
      color: var(--circl-blue);
      font-weight: 500;
    }

    .results-type.ai-random {
      color: var(--circl-teal);
    }

    .results-time {
      font-size: 20px;
      font-weight: 700;
      color: var(--circl-text-primary);
      font-family: monospace;
    }

    .results-time small {
      font-size: 12px;
      font-weight: 400;
      color: var(--circl-text-secondary);
    }
  </style>
</head>
<body>
  <!-- TOP HEADER BAR -->
  <header class="top-header">
    <div class="header-left">
      <a class="circl-logo" href="#">
        <div class="circl-logo-icon">
          <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#1877F2"/>
                <stop offset="100%" style="stop-color:#00A3A3"/>
              </linearGradient>
            </defs>
            <circle cx="20" cy="20" r="20" fill="url(#logoGrad)"/>
            <circle cx="15" cy="16" r="7" stroke="white" stroke-width="2.5" fill="none"/>
            <circle cx="25" cy="24" r="7" stroke="white" stroke-width="2.5" fill="none"/>
          </svg>
        </div>
        <span class="circl-logo-text">Circl</span>
      </a>
      <div class="header-search">
        <i class="fas fa-magnifying-glass"></i>
        <input type="text" placeholder="Search Circl" disabled>
      </div>
    </div>
    
    <div class="header-center">
      <div class="header-nav-item active" id="nav-home-top" onclick="switchMode('feed')">
        <i class="fas fa-house"></i>
      </div>
      <div class="header-nav-item">
        <i class="fas fa-user-group"></i>
      </div>
      <div class="header-nav-item">
        <i class="fas fa-tv"></i>
      </div>
      <div class="header-nav-item">
        <i class="fas fa-store"></i>
      </div>
      <div class="header-nav-item" id="nav-qc-top" onclick="switchMode('qc')">
        <i class="fas fa-clipboard-check"></i>
      </div>
      <div class="header-nav-item" id="nav-exp-top" onclick="switchMode('experience')">
        <i class="fas fa-flask"></i>
      </div>
    </div>
    
    <div class="header-right">
      <button class="header-icon-btn"><i class="fas fa-grip"></i></button>
      <button class="header-icon-btn"><i class="fab fa-facebook-messenger"></i></button>
      <button class="header-icon-btn"><i class="fas fa-bell"></i></button>
      <div class="header-profile">U</div>
    </div>
  </header>

  <div class="app-container">
    <!-- LEFT SIDEBAR -->
    <aside class="sidebar-left">
      <a class="sidebar-nav-item active" id="nav-home" onclick="switchMode('feed')">
        <div class="sidebar-nav-icon"><i class="fas fa-house"></i></div>
        <span>Home</span>
      </a>
      <a class="sidebar-nav-item">
        <div class="sidebar-nav-icon"><i class="fas fa-user-group"></i></div>
        <span>Friends</span>
      </a>
      <a class="sidebar-nav-item">
        <div class="sidebar-nav-icon"><i class="fas fa-tv"></i></div>
        <span>Watch</span>
      </a>
      <a class="sidebar-nav-item">
        <div class="sidebar-nav-icon"><i class="fas fa-store"></i></div>
        <span>Marketplace</span>
      </a>
      <a class="sidebar-nav-item">
        <div class="sidebar-nav-icon"><i class="fas fa-users"></i></div>
        <span>Groups</span>
      </a>
      
      <div class="sidebar-divider"></div>
      
      <a class="sidebar-nav-item" id="nav-qc" onclick="switchMode('qc')">
        <div class="sidebar-nav-icon"><i class="fas fa-clipboard-check"></i></div>
        <span>Quality Control</span>
      </a>
      <a class="sidebar-nav-item" id="nav-exp" onclick="switchMode('experience')">
        <div class="sidebar-nav-icon"><i class="fas fa-flask"></i></div>
        <span>Experience</span>
      </a>
      <a class="sidebar-nav-item">
        <div class="sidebar-nav-icon"><i class="fas fa-bookmark"></i></div>
        <span>Saved</span>
      </a>
      <a class="sidebar-nav-item">
        <div class="sidebar-nav-icon"><i class="fas fa-clock-rotate-left"></i></div>
        <span>Memories</span>
      </a>
      
      <div class="sidebar-divider"></div>
      <div class="sidebar-section-title">Shortcuts</div>
      
      <a class="sidebar-nav-item">
        <div class="sidebar-nav-icon" style="background: #4267B2;"><i class="fas fa-microscope" style="color: white; font-size: 16px;"></i></div>
        <span>AI Experiment</span>
      </a>
    </aside>

    <!-- MAIN FEED -->
    <main class="main-feed">
      <!-- Create Post Box -->
      <div class="create-post-box">
        <div class="create-post-top">
          <div class="create-post-avatar">U</div>
          <div class="create-post-input">What's on your mind?</div>
        </div>
        <div class="create-post-divider"></div>
        <div class="create-post-actions">
          <div class="create-post-action">
            <i class="fas fa-video"></i>
            <span>Live video</span>
          </div>
          <div class="create-post-action">
            <i class="fas fa-images"></i>
            <span>Photo/video</span>
          </div>
          <div class="create-post-action">
            <i class="far fa-face-smile"></i>
            <span>Feeling/activity</span>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div class="loading" id="loading">
        <i class="fas fa-spinner"></i>
        <p>Loading posts...</p>
      </div>

      <!-- Posts Container -->
      <div id="posts-container"></div>

      <!-- No Results -->
      <div class="no-results hidden" id="no-results">
        <i class="far fa-face-frown"></i>
        <h3>No posts found</h3>
        <p>Try changing the filter combination</p>
      </div>
    </main>

    <!-- QUALITY CONTROL MODE -->
    <div class="qc-container" id="qc-container">
      <div class="qc-header">
        <div class="qc-header-top">
          <div class="qc-title"><i class="fas fa-clipboard-check"></i> Quality Control</div>
          <div class="qc-progress" id="qc-progress">Image 1 of 0</div>
        </div>
        <div class="qc-coder-row">
          <label style="font-size: 14px; color: var(--circl-text-secondary);">Coder ID:</label>
          <input type="text" class="qc-coder-input" id="qc-coder-id" placeholder="Enter your ID">
          <div class="qc-filter-toggle">
            <input type="checkbox" id="qc-uncoded-only">
            <label for="qc-uncoded-only">Show uncoded only</label>
          </div>
        </div>
      </div>

      <div class="qc-content">
        <div class="qc-image-panel">
          <div class="qc-image-nav">
            <button class="qc-nav-btn" id="qc-prev" onclick="qcNavigate(-1)">
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            <div class="qc-image-counter" id="qc-counter">1 / 0</div>
            <button class="qc-nav-btn" id="qc-next" onclick="qcNavigate(1)">
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <div class="qc-image-wrapper">
            <img id="qc-image" src="" alt="Image to rate">
          </div>

          <div class="qc-condition-info" id="qc-condition-info">
            <!-- Condition tags will be inserted here -->
          </div>
        </div>

        <div class="qc-form-panel">
          <form id="qc-form" onsubmit="submitQCForm(event)">
            <!-- Binary Criteria -->
            <div class="qc-form-section">
              <div class="qc-form-section-title">Quality Criteria</div>
              
              <div class="qc-field">
                <label class="qc-field-label">No prominent weird/garbled text?</label>
                <div class="qc-radio-group">
                  <div class="qc-radio-option">
                    <input type="radio" name="no_weird_text" id="nwt-yes" value="yes" required>
                    <label for="nwt-yes">Yes</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="no_weird_text" id="nwt-no" value="no">
                    <label for="nwt-no">No</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="no_weird_text" id="nwt-unclear" value="unclear">
                    <label for="nwt-unclear">Unclear</label>
                  </div>
                </div>
              </div>

              <div class="qc-field">
                <label class="qc-field-label">Outgroup member(s) present?</label>
                <div class="qc-radio-group">
                  <div class="qc-radio-option">
                    <input type="radio" name="outgroup_present" id="op-yes" value="yes" required>
                    <label for="op-yes">Yes</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="outgroup_present" id="op-no" value="no">
                    <label for="op-no">No</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="outgroup_present" id="op-unclear" value="unclear">
                    <label for="op-unclear">Unclear</label>
                  </div>
                </div>
              </div>

              <div class="qc-field">
                <label class="qc-field-label">Looks authentic/realistic (not obviously AI)?</label>
                <div class="qc-radio-group">
                  <div class="qc-radio-option">
                    <input type="radio" name="looks_authentic" id="la-yes" value="yes" required>
                    <label for="la-yes">Yes</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="looks_authentic" id="la-no" value="no">
                    <label for="la-no">No</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="looks_authentic" id="la-unclear" value="unclear">
                    <label for="la-unclear">Unclear</label>
                  </div>
                </div>
              </div>

              <div class="qc-field">
                <label class="qc-field-label">Age representation matches condition?</label>
                <div class="qc-radio-group">
                  <div class="qc-radio-option">
                    <input type="radio" name="age_accurate" id="aa-yes" value="yes" required>
                    <label for="aa-yes">Yes</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="age_accurate" id="aa-no" value="no">
                    <label for="aa-no">No</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="age_accurate" id="aa-unclear" value="unclear">
                    <label for="aa-unclear">Unclear</label>
                  </div>
                </div>
              </div>

              <div class="qc-field">
                <label class="qc-field-label">Gender representation matches condition?</label>
                <div class="qc-radio-group">
                  <div class="qc-radio-option">
                    <input type="radio" name="gender_accurate" id="ga-yes" value="yes" required>
                    <label for="ga-yes">Yes</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="gender_accurate" id="ga-no" value="no">
                    <label for="ga-no">No</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="gender_accurate" id="ga-unclear" value="unclear">
                    <label for="ga-unclear">Unclear</label>
                  </div>
                </div>
              </div>

              <div class="qc-field">
                <label class="qc-field-label">Ideology representation matches condition?</label>
                <div class="qc-radio-group">
                  <div class="qc-radio-option">
                    <input type="radio" name="ideology_accurate" id="ia-yes" value="yes" required>
                    <label for="ia-yes">Yes</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="ideology_accurate" id="ia-no" value="no">
                    <label for="ia-no">No</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="ideology_accurate" id="ia-unclear" value="unclear">
                    <label for="ia-unclear">Unclear</label>
                  </div>
                </div>
              </div>

              <div class="qc-field">
                <label class="qc-field-label">Issue representation matches condition?</label>
                <div class="qc-radio-group">
                  <div class="qc-radio-option">
                    <input type="radio" name="issue_accurate" id="isa-yes" value="yes" required>
                    <label for="isa-yes">Yes</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="issue_accurate" id="isa-no" value="no">
                    <label for="isa-no">No</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="issue_accurate" id="isa-unclear" value="unclear">
                    <label for="isa-unclear">Unclear</label>
                  </div>
                </div>
              </div>

              <div class="qc-field">
                <label class="qc-field-label">Suitable for experiment (overall)?</label>
                <div class="qc-radio-group">
                  <div class="qc-radio-option">
                    <input type="radio" name="suitable" id="su-yes" value="yes" required>
                    <label for="su-yes">Yes</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="suitable" id="su-no" value="no">
                    <label for="su-no">No</label>
                  </div>
                  <div class="qc-radio-option">
                    <input type="radio" name="suitable" id="su-unclear" value="unclear">
                    <label for="su-unclear">Unclear</label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Scales -->
            <div class="qc-form-section">
              <div class="qc-form-section-title">Ratings</div>

              <div class="qc-field">
                <label class="qc-field-label">Image Quality</label>
                <div class="qc-star-rating" id="qc-star-rating">
                  <i class="fas fa-star qc-star" data-value="1"></i>
                  <i class="fas fa-star qc-star" data-value="2"></i>
                  <i class="fas fa-star qc-star" data-value="3"></i>
                  <i class="fas fa-star qc-star" data-value="4"></i>
                  <i class="fas fa-star qc-star" data-value="5"></i>
                </div>
                <input type="hidden" name="image_quality" id="image_quality" value="0" required>
              </div>

              <div class="qc-field">
                <label class="qc-field-label">Emotional Intensity (0-10)</label>
                <div class="qc-range-container">
                  <input type="range" class="qc-range" name="emotional_intensity" id="emotional_intensity" min="0" max="10" value="5">
                  <span class="qc-range-value" id="intensity-value">5</span>
                </div>
              </div>

              <div class="qc-field">
                <label class="qc-field-label">Emotional Valence</label>
                <div class="qc-valence-scale">
                  <div class="qc-valence-option">
                    <input type="radio" name="emotional_valence" id="ev-vn" value="very_negative" required>
                    <label for="ev-vn">Very Neg</label>
                  </div>
                  <div class="qc-valence-option">
                    <input type="radio" name="emotional_valence" id="ev-n" value="negative">
                    <label for="ev-n">Negative</label>
                  </div>
                  <div class="qc-valence-option">
                    <input type="radio" name="emotional_valence" id="ev-neu" value="neutral">
                    <label for="ev-neu">Neutral</label>
                  </div>
                  <div class="qc-valence-option">
                    <input type="radio" name="emotional_valence" id="ev-p" value="positive">
                    <label for="ev-p">Positive</label>
                  </div>
                  <div class="qc-valence-option">
                    <input type="radio" name="emotional_valence" id="ev-vp" value="very_positive">
                    <label for="ev-vp">Very Pos</label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Notes -->
            <div class="qc-form-section">
              <div class="qc-form-section-title">Notes</div>
              <textarea class="qc-notes" name="notes" id="qc-notes" placeholder="Any additional observations..."></textarea>
            </div>

            <!-- Submit -->
            <button type="submit" class="qc-submit-btn" id="qc-submit-btn">
              <i class="fas fa-check"></i> Submit & Next
            </button>
            <div class="qc-status" id="qc-status"></div>
          </form>
        </div>
      </div>
    </div>

    <!-- EXPERIENCE MODE CONTAINER -->
    <div id="experience-container" class="experience-container">
      <!-- Survey Screen -->
      <div id="experience-survey" class="experience-survey">
        <div class="experience-survey-card">
          <div class="experience-survey-header">
            <div class="experience-logo">
              <svg viewBox="0 0 48 48" width="48" height="48">
                <defs>
                  <linearGradient id="expGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#1877F2"/>
                    <stop offset="100%" style="stop-color:#00A3A3"/>
                  </linearGradient>
                </defs>
                <circle cx="24" cy="24" r="22" fill="url(#expGrad)"/>
                <circle cx="24" cy="24" r="14" fill="none" stroke="white" stroke-width="3"/>
                <circle cx="24" cy="24" r="6" fill="white"/>
              </svg>
            </div>
            <h1 class="experience-title">Personalize Your Feed</h1>
            <p class="experience-subtitle">Help us tailor your experience by answering a few quick questions</p>
          </div>

          <div class="experience-form">
            <!-- Gender -->
            <div class="experience-field">
              <label class="experience-label">What is your gender?</label>
              <div class="experience-options gender-options">
                <button type="button" class="experience-option" data-field="gender" data-value="female">
                  <i class="fas fa-venus"></i>
                  <span>Female</span>
                </button>
                <button type="button" class="experience-option" data-field="gender" data-value="male">
                  <i class="fas fa-mars"></i>
                  <span>Male</span>
                </button>
              </div>
            </div>

            <!-- Age -->
            <div class="experience-field">
              <label class="experience-label">What is your age group?</label>
              <div class="experience-options age-options">
                <button type="button" class="experience-option" data-field="age" data-value="18-29">
                  <span>18-29</span>
                </button>
                <button type="button" class="experience-option" data-field="age" data-value="30-44">
                  <span>30-44</span>
                </button>
                <button type="button" class="experience-option" data-field="age" data-value="45-59">
                  <span>45-59</span>
                </button>
                <button type="button" class="experience-option" data-field="age" data-value="60+">
                  <span>60+</span>
                </button>
              </div>
            </div>

            <!-- Political Leaning -->
            <div class="experience-field">
              <label class="experience-label">Where do you place yourself politically?</label>
              <div class="experience-slider-container">
                <div class="experience-slider-labels">
                  <span class="slider-label-left">Left</span>
                  <span class="slider-label-center">Center</span>
                  <span class="slider-label-right">Right</span>
                </div>
                <input type="range" id="political-slider" class="experience-slider" min="0" max="10" value="5" step="1">
                <div class="experience-slider-ticks">
                  <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
                </div>
                <div class="experience-slider-value" id="political-value">
                  <span class="ideology-badge neutral">Center (5)</span>
                </div>
              </div>
            </div>

            <!-- Issue -->
            <div class="experience-field">
              <label class="experience-label">Which issue matters most to you?</label>
              <div class="experience-options issue-options">
                <button type="button" class="experience-option issue-btn" data-field="issue" data-value="Affordable_childcare_access">
                  <i class="fas fa-baby"></i>
                  <span>Childcare</span>
                </button>
                <button type="button" class="experience-option issue-btn" data-field="issue" data-value="Build_more_homes_accelerate_construction">
                  <i class="fas fa-house"></i>
                  <span>Housing</span>
                </button>
                <button type="button" class="experience-option issue-btn" data-field="issue" data-value="CO2_levy_for_industry_climate">
                  <i class="fas fa-leaf"></i>
                  <span>Climate</span>
                </button>
                <button type="button" class="experience-option issue-btn" data-field="issue" data-value="purchasing_power">
                  <i class="fas fa-wallet"></i>
                  <span>Cost of Living</span>
                </button>
                <button type="button" class="experience-option issue-btn" data-field="issue" data-value="stop_weapon_ship_to_israel">
                  <i class="fas fa-dove"></i>
                  <span>Israel/Peace</span>
                </button>
              </div>
            </div>

            <!-- Debug Mode Toggle -->
            <div class="experience-field debug-toggle-field">
              <label class="debug-toggle-label">
                <input type="checkbox" id="debug-mode-toggle">
                <span class="debug-toggle-switch"></span>
                <span class="debug-toggle-text">Enable Debug Mode</span>
              </label>
              <p class="debug-toggle-hint">Shows AI post reasons and tracks viewing time</p>
            </div>

            <!-- Submit -->
            <button type="button" class="experience-submit" id="experience-submit" disabled>
              <span>Show My Feed</span>
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Experience Feed -->
      <div id="experience-feed" class="experience-feed hidden">
        <div class="experience-feed-header">
          <button class="experience-back-btn" onclick="resetExperience()">
            <i class="fas fa-arrow-left"></i>
            <span>Start Over</span>
          </button>
          <div class="experience-feed-info">
            <span id="experience-profile-summary"></span>
          </div>
          <button class="experience-toggle-labels" id="experience-toggle-labels" onclick="toggleExperienceLabels()">
            <i class="fas fa-eye"></i>
            <span>Show AI</span>
          </button>
        </div>
        <div class="experience-posts-container" id="experience-posts"></div>
        <button class="experience-results-btn" id="experience-results-btn" onclick="showResults()">
          <i class="fas fa-chart-bar"></i> View Attention Results
        </button>
      </div>
    </div>

    <!-- Results Modal -->
    <div class="results-modal" id="results-modal">
      <div class="results-card">
        <div class="results-header">
          <h2 class="results-title">ð Top 5 Most Viewed Posts</h2>
          <button class="results-close" onclick="closeResults()"><i class="fas fa-times"></i></button>
        </div>
        <div class="results-content" id="results-content">
          <!-- Results will be inserted here -->
        </div>
      </div>
    </div>

    <!-- RIGHT SIDEBAR - FILTERS -->
    <aside class="sidebar-right">
      <div class="filter-card">
        <div class="filter-card-header">Filter Posts</div>
        
        <div class="filter-group">
          <div class="filter-label">Age Group</div>
          <select id="filter-age"></select>
        </div>
        
        <div class="filter-group">
          <div class="filter-label">Gender</div>
          <select id="filter-gender"></select>
        </div>
        
        <div class="filter-group">
          <div class="filter-label">Policy Issue</div>
          <select id="filter-policy"></select>
        </div>
        
        <div class="filter-group">
          <div class="filter-label">Ideology</div>
          <select id="filter-ideology"></select>
        </div>

        <div class="filter-info">
          <div class="filter-info-text"><span id="visible-count">0</span> post(s) shown</div>
          <div class="filter-info-sub">Matching current filters</div>
        </div>

        <div class="filter-group">
          <div class="input-row">
            <label class="input-label">Additional posts</label>
            <input type="number" id="additional-posts" value="4" min="0" max="20" class="number-input">
          </div>
          <button class="generate-feed-btn" onclick="generateMixedFeed()">
            <i class="fas fa-shuffle"></i> Generate Mixed Feed
          </button>
          <div class="toggle-row">
            <button class="toggle-btn" id="toggle-ai-label" onclick="toggleAILabel()">
              <i class="fas fa-tag"></i> Show AI Label
            </button>
          </div>
        </div>
      </div>

      <div class="filter-card">
        <div class="filter-card-header">Keyboard Shortcuts</div>
        <div class="filter-group" style="font-size: 13px; color: var(--circl-text-secondary);">
          <p style="margin-bottom: 8px;"><kbd style="background: var(--circl-gray-200); padding: 2px 6px; border-radius: 4px;">â</kbd> <kbd style="background: var(--circl-gray-200); padding: 2px 6px; border-radius: 4px;">â</kbd> Navigate images</p>
          <p>Click image carousel to focus</p>
        </div>
      </div>

      <!-- Simulated Sponsored Section -->
      <div class="filter-card sponsored-card">
        <div class="filter-card-header">Sponsored</div>
        <div class="sponsored-item" onclick="showReactionStatus('This is a simulated sponsored post', 'success')">
          <img src="https://picsum.photos/seed/sponsored1/80/80" alt="Sponsored">
          <div class="sponsored-info">
            <div class="sponsored-title">Discover New Horizons</div>
            <div class="sponsored-site">horizons.example.com</div>
          </div>
        </div>
        <div class="sponsored-item" onclick="showReactionStatus('This is a simulated sponsored post', 'success')">
          <img src="https://picsum.photos/seed/sponsored2/80/80" alt="Sponsored">
          <div class="sponsored-info">
            <div class="sponsored-title">Tech Solutions Pro</div>
            <div class="sponsored-site">techsolutions.example.com</div>
          </div>
        </div>
      </div>

      <!-- Simulated Contacts Section -->
      <div class="filter-card contacts-card">
        <div class="filter-card-header">
          Contacts
          <div class="contacts-header-icons">
            <i class="fas fa-video"></i>
            <i class="fas fa-search"></i>
            <i class="fas fa-ellipsis"></i>
          </div>
        </div>
        <div class="contact-list">
          <div class="contact-item" onclick="showReactionStatus('Chat simulation - Maria is online', 'success')">
            <div class="contact-avatar" style="background: linear-gradient(135deg, #FF6B6B, #FF8E53);">MR</div>
            <span class="contact-name">Maria Rodriguez</span>
            <span class="online-dot"></span>
          </div>
          <div class="contact-item" onclick="showReactionStatus('Chat simulation - Jan is online', 'success')">
            <div class="contact-avatar" style="background: linear-gradient(135deg, #4ECDC4, #45B7D1);">JV</div>
            <span class="contact-name">Jan Vermeer</span>
            <span class="online-dot"></span>
          </div>
          <div class="contact-item" onclick="showReactionStatus('Chat simulation - Sophie is online', 'success')">
            <div class="contact-avatar" style="background: linear-gradient(135deg, #A8E6CF, #88D8B0);">SD</div>
            <span class="contact-name">Sophie de Vries</span>
            <span class="online-dot"></span>
          </div>
          <div class="contact-item" onclick="showReactionStatus('Chat simulation - Pieter is away', 'success')">
            <div class="contact-avatar" style="background: linear-gradient(135deg, #FFD93D, #FF6B6B);">PJ</div>
            <span class="contact-name">Pieter Jansen</span>
            <span class="away-dot"></span>
          </div>
          <div class="contact-item" onclick="showReactionStatus('Chat simulation - Emma is online', 'success')">
            <div class="contact-avatar" style="background: linear-gradient(135deg, #C9B1FF, #A78BFA);">EB</div>
            <span class="contact-name">Emma Bakker</span>
            <span class="online-dot"></span>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- MOBILE BOTTOM NAVIGATION -->
  <nav class="mobile-nav">
    <a class="mobile-nav-item active" onclick="switchMode('feed')">
      <i class="fas fa-house"></i>
      <span>Home</span>
    </a>
    <a class="mobile-nav-item">
      <i class="fas fa-user-group"></i>
      <span>Friends</span>
    </a>
    <a class="mobile-nav-item">
      <i class="fas fa-tv"></i>
      <span>Watch</span>
    </a>
    <a class="mobile-nav-item" onclick="switchMode('qc')">
      <i class="fas fa-clipboard-check"></i>
      <span>QC</span>
    </a>
    <a class="mobile-nav-item">
      <i class="fas fa-bars"></i>
      <span>Menu</span>
    </a>
  </nav>

  <!-- COMMENT MODAL -->
  <div class="comment-modal-overlay" id="comment-modal-overlay">
    <div class="comment-modal">
      <div class="comment-modal-header">
        <div class="comment-modal-title">Write a comment</div>
        <button class="comment-modal-close" onclick="hideCommentModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="comment-modal-content">
        <div class="comment-post-preview" id="comment-post-preview">
          <!-- Post preview will be inserted here -->
        </div>
        <textarea 
          class="comment-textarea" 
          id="comment-textarea" 
          placeholder="Write a comment..."
          maxlength="500"
        ></textarea>
      </div>
      <div class="comment-modal-footer">
        <button class="comment-btn comment-btn-cancel" onclick="hideCommentModal()">Cancel</button>
        <button class="comment-btn comment-btn-submit" onclick="submitComment()">
          <i class="fas fa-paper-plane"></i> Comment
        </button>
      </div>
    </div>
  </div>

  <!-- REACTION STATUS NOTIFICATION -->
  <div class="reaction-status" id="reaction-status"></div>

  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script>
    let conditionsData = null;
    let choicesInstances = {};
    let isMixedFeedMode = false;
    let showAILabel = false;

    // Post templates (Facebook style - more casual)
    const postTemplates = [
      "Dit is wat er echt speelt in onze samenleving. We moeten hier iets aan doen! ð  {hashtags}",
      "Kijk naar dit beeld en vertel me dat dit acceptabel is. {hashtags}",
      "De realiteit van vandaag. Wanneer gaan we eindelijk actie ondernemen? {hashtags}",
      "Dit raakt miljoenen Nederlanders. Het is tijd voor verandering. ðª {hashtags}",
      "Herkenbaar? Dit is de werkelijkheid voor veel mensen in ons land. {hashtags}",
      "We kunnen niet langer wegkijken. Dit moet anders! {hashtags}",
      "Een beeld zegt meer dan duizend woorden. Dit is Nederland vandaag. {hashtags}",
      "Hoelang blijven we dit nog accepteren? Er moet nu iets gebeuren. {hashtags}",
      "Stem van de straat. Dit is wat mensen Ã©cht bezighoudt. {hashtags}",
      "De feiten spreken voor zich. Tijd om te handelen! {hashtags}"
    ];

    async function loadData() {
      try {
        const response = await fetch('../conditions.json');
        if (!response.ok) throw new Error('Failed to load');
        conditionsData = await response.json();
        initFilters();
        renderPosts();
        applyFilters();
        document.getElementById('loading').classList.add('hidden');
      } catch (error) {
        document.getElementById('loading').innerHTML = `
          <i class="fas fa-exclamation-triangle" style="animation:none; color: var(--circl-red);"></i>
          <p style="margin-top:12px; color: var(--circl-text-primary);">Could not load posts</p>
          <p style="font-size:13px; color: var(--circl-text-secondary); margin-top:8px">Run: python3 generate_conditions_json.py</p>
        `;
      }
    }

    // Display names for policy issues
    const policyDisplayNames = {
      'Affordable_childcare_access': 'Affordable childcare (access)',
      'Build_more_homes_accelerate_construction': 'Build more homes (construction)',
      'CO2_levy_for_industry_climate': 'CO2 levy for industry (climate)',
      'purchasing_power': 'Strengthen purchasing power (cost of living)',
      'stop_weapon_ship_to_israel': 'Stop weapon shipments to Israel'
    };

    // Hashtag-friendly names for policy issues
    const policyHashtags = {
      'Affordable_childcare_access': 'Kinderopvang',
      'Build_more_homes_accelerate_construction': 'Woningbouw',
      'CO2_levy_for_industry_climate': 'Klimaat',
      'purchasing_power': 'Koopkracht',
      'stop_weapon_ship_to_israel': 'IsraelWapens'
    };

    function initFilters() {
      const { filters } = conditionsData;
      
      populateSelect('filter-age', filters.age_groups);
      populateSelect('filter-gender', filters.genders, v => v.charAt(0).toUpperCase() + v.slice(1));
      populateSelect('filter-policy', filters.policy_issues, v => policyDisplayNames[v] || v.replace(/_/g, ' '));
      populateSelect('filter-ideology', filters.ideologies, v => v.charAt(0).toUpperCase() + v.slice(1));
      
      ['filter-age', 'filter-gender', 'filter-policy', 'filter-ideology'].forEach(id => {
        const el = document.getElementById(id);
        choicesInstances[id] = new Choices(el, {
          searchEnabled: false,
          itemSelectText: '',
          shouldSort: false
        });
        el.addEventListener('change', applyFilters);
      });
    }

    function populateSelect(id, values, labelFn = v => v) {
      const select = document.getElementById(id);
      values.forEach((value, i) => {
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = labelFn(value);
        if (i === 0) opt.selected = true;
        select.appendChild(opt);
      });
    }

    function renderPosts() {
      const container = document.getElementById('posts-container');
      container.innerHTML = '';
      
      conditionsData.conditions.forEach((cond, idx) => {
        container.appendChild(createPost(cond, idx));
      });
      
      initCarousels();
      attachReactionListeners();
    }

    function createPost(cond, idx) {
      const post = document.createElement('article');
      post.className = 'post ai-post';
      post.dataset.age = cond.age_group;
      post.dataset.gender = cond.gender;
      post.dataset.policy = cond.policy_issue;
      post.dataset.ideology = cond.ideology;
      
      const postId = `post-${cond.condition_id}-${idx}`;
      post.dataset.postId = postId;
      
      const name = `${cond.gender.charAt(0).toUpperCase() + cond.gender.slice(1)} ${cond.age_group}`;
      const handle = `${cond.ideology.charAt(0).toUpperCase() + cond.ideology.slice(1)} voter`;
      const time = `${Math.floor(Math.random() * 23) + 1}h`;
      const initials = cond.age_group.slice(0, 2) + cond.gender.charAt(0).toUpperCase();
      
      const policyTag = policyHashtags[cond.policy_issue] || cond.policy_issue.replace(/_/g, '');
      const hashtags = `#${cond.ideology} #${policyTag}`;
      const postTextContent = postTemplates[Math.floor(Math.random() * postTemplates.length)]
        .replace('{hashtags}', `<span class="post-hashtag">${hashtags}</span>`);
      
      const slidesHtml = cond.images.map(img => 
        `<div class="carousel-slide"><img src="../generated_images/${cond.image_dir}/${img}" loading="lazy"></div>`
      ).join('');
      
      const dotsHtml = cond.images.map((_, i) => 
        `<button class="carousel-dot${i === 0 ? ' active' : ''}" data-index="${i}"></button>`
      ).join('');
      
      const eng = {
        likes: Math.floor(Math.random() * 500) + 50,
        comments: Math.floor(Math.random() * 50) + 5,
        shares: Math.floor(Math.random() * 200) + 20
      };
      
      const badgeClass = showAILabel ? 'ai-badge' : 'ai-badge hidden';
      
      post.innerHTML = `
        <div class="post-header-section">
          <div class="post-header">
            <div class="post-avatar">${initials}</div>
            <div class="post-header-info">
              <div class="post-name-row">
                <span class="post-name">${name}</span>
                <i class="fas fa-circle-check post-verified"></i>
                <span class="${badgeClass}">AI Generated</span>
              </div>
              <div class="post-meta">
                <span>${handle}</span>
                <span>Â·</span>
                <span>${time}</span>
                <span>Â·</span>
                <i class="fas fa-earth-americas"></i>
              </div>
            </div>
            <div class="post-more"><i class="fas fa-ellipsis"></i></div>
          </div>
        </div>
        <div class="post-content">
          <div class="post-text">${postTextContent}</div>
        </div>
        <div class="post-media" data-carousel="${idx}">
          <div class="carousel-counter"><span class="current">1</span>/${cond.images.length}</div>
          <div class="carousel-track">${slidesHtml}</div>
          <button class="carousel-nav prev"><i class="fas fa-chevron-left"></i></button>
          <button class="carousel-nav next"><i class="fas fa-chevron-right"></i></button>
          <div class="carousel-dots">${dotsHtml}</div>
        </div>
        <div class="post-reactions-bar">
          <div class="post-reactions-count">
            <div class="reaction-icons">
              <div class="reaction-icon like"><i class="fas fa-thumbs-up"></i></div>
            </div>
            <span class="like-count">${eng.likes}</span>
          </div>
          <div class="post-engagement-count"><span class="comment-count">${eng.comments}</span> comments Â· <span class="share-count">${eng.shares}</span> shares</div>
        </div>
        <div class="post-actions">
          <div class="post-action like" data-action="like"><i class="far fa-thumbs-up"></i> <span>Like</span></div>
          <div class="post-action reply" data-action="comment"><i class="far fa-comment"></i> <span>Comment</span></div>
          <div class="post-action repost" data-action="share"><i class="fas fa-share"></i> <span>Share</span></div>
        </div>
      `;
      
      // Store post data for interactions
      post._postData = {
        postId: postId,
        postType: 'ai',
        conditionId: cond.condition_id,
        name: name,
        handle: handle,
        text: postTextContent.replace(/<[^>]*>/g, ''),
        likes: eng.likes,
        comments: eng.comments,
        shares: eng.shares
      };
      
      return post;
    }

    function applyFilters() {
      if (isMixedFeedMode) {
        generateMixedFeed();
        return;
      }
      
      const age = document.getElementById('filter-age').value;
      const gender = document.getElementById('filter-gender').value;
      const policy = document.getElementById('filter-policy').value;
      const ideology = document.getElementById('filter-ideology').value;
      
      let count = 0;
      document.querySelectorAll('.post').forEach(post => {
        const match = post.dataset.age === age && 
                      post.dataset.gender === gender && 
                      post.dataset.policy === policy && 
                      post.dataset.ideology === ideology;
        post.classList.toggle('hidden', !match);
        if (match) count++;
      });
      
      document.getElementById('visible-count').textContent = count;
      document.getElementById('no-results').classList.toggle('hidden', count > 0);
      document.getElementById('posts-container').classList.toggle('hidden', count === 0);
    }

    function initCarousels() {
      document.querySelectorAll('[data-carousel]').forEach(carousel => {
        const track = carousel.querySelector('.carousel-track');
        const slides = carousel.querySelectorAll('.carousel-slide');
        const dots = carousel.querySelectorAll('.carousel-dot');
        const counter = carousel.querySelector('.current');
        let current = 0;
        
        const go = (i) => {
          if (i < 0) i = slides.length - 1;
          if (i >= slides.length) i = 0;
          current = i;
          track.style.transform = `translateX(-${current * 100}%)`;
          dots.forEach((d, j) => d.classList.toggle('active', j === current));
          if (counter) counter.textContent = current + 1;
        };
        
        carousel.querySelector('.prev')?.addEventListener('click', e => { e.stopPropagation(); go(current - 1); });
        carousel.querySelector('.next')?.addEventListener('click', e => { e.stopPropagation(); go(current + 1); });
        dots.forEach((d, i) => d.addEventListener('click', e => { e.stopPropagation(); go(i); }));
        
        carousel.addEventListener('keydown', e => {
          if (e.key === 'ArrowLeft') go(current - 1);
          if (e.key === 'ArrowRight') go(current + 1);
        });
        carousel.tabIndex = 0;
      });
    }

    // ============================================
    // MIXED FEED GENERATOR
    // ============================================
    
    const placeholderNames = [
      { name: 'Emma de Vries', handle: 'Friend', initials: 'EV' },
      { name: 'Thomas Bakker', handle: 'Friend', initials: 'TB' },
      { name: 'Sophie Jansen', handle: 'Friend', initials: 'SJ' },
      { name: 'Lars van Dijk', handle: 'Friend', initials: 'LD' },
      { name: 'Lisa Mulder', handle: 'Friend', initials: 'LM' },
      { name: 'Max Visser', handle: 'Suggested for you', initials: 'MV' },
      { name: 'Anna Smit', handle: 'Friend', initials: 'AS' },
      { name: 'Daan de Boer', handle: 'Suggested for you', initials: 'DB' },
      { name: 'Fleur Hendriks', handle: 'Friend', initials: 'FH' },
      { name: 'Bram Peters', handle: 'Friend', initials: 'BP' }
    ];

    const placeholderPosts = [
      "Net terug van een geweldige wandeling in het park. De natuur is prachtig deze tijd van het jaar! ð³",
      "Wie heeft er tips voor een goed restaurant in Amsterdam? Vieren dit weekend een verjaardag ð",
      "Die nieuwe serie op Netflix is echt verslavend. Al 5 afleveringen gekeken vanavond ð",
      "Eindelijk vrijdag! Wat zijn jullie plannen voor het weekend? ð",
      "Koffie is gezet, laptop open, laten we aan de slag gaan. Productieve dag iedereen! â",
      "Mijn kat heeft weer iets kapot gemaakt. Dit is waarom we geen mooie dingen kunnen hebben ð±",
      "Wat een weer vandaag! Perfect voor een terrasje âï¸",
      "Boek uitgelezen. Aanrader: 'De zeven zussen'. Iemand andere tips?",
      "Update: de IKEA kast is EINDELIJK in elkaar gezet. Slechts 4 uur en 2 mentale breakdowns later ð§",
      "Thuiswerken dag 847: ik praat nu tegen mijn planten. Ze luisteren beter dan mijn collega's ðª´",
      "PSA: de stroopwafels bij Albert Heijn zijn in de aanbieding. Je bent welkom.",
      "Nog 3 maanden tot vakantie. Ik tel af. âï¸",
      "Waarom is de NS altijd vertraagd als ik op tijd ben, maar op tijd als ik te laat ben? ð",
      "Net ontdekt dat mijn buurman ook op Circl zit. Awkward wave incoming ð",
      "Tip: nooit boodschappen doen als je honger hebt. Mijn rekening was â¬120 voor 'snacks' ð"
    ];

    function generateMixedFeed() {
      isMixedFeedMode = true;
      
      const age = document.getElementById('filter-age').value;
      const gender = document.getElementById('filter-gender').value;
      const policy = document.getElementById('filter-policy').value;
      const ideology = document.getElementById('filter-ideology').value;
      
      const aiCondition = conditionsData.conditions.find(c => 
        c.age_group === age && 
        c.gender === gender && 
        c.policy_issue === policy && 
        c.ideology === ideology
      );
      
      if (!aiCondition) {
        alert('No matching condition found. Please check your filter selection.');
        return;
      }
      
      const container = document.getElementById('posts-container');
      container.innerHTML = '';
      
      const indicator = document.createElement('div');
      indicator.className = 'feed-mode-indicator';
      indicator.innerHTML = `
        <span><i class="fas fa-shuffle"></i> Mixed Feed Mode</span>
        <button onclick="exitMixedFeed()"><i class="fas fa-times"></i> Exit</button>
      `;
      container.appendChild(indicator);
      
      const posts = [];
      const additionalPosts = parseInt(document.getElementById('additional-posts').value) || 4;
      
      for (let i = 0; i < additionalPosts; i++) {
        posts.push(createPlaceholderPost(i));
      }
      
      posts.push(createAIPost(aiCondition));
      shuffleArray(posts);
      
      posts.forEach(post => container.appendChild(post));
      initCarousels();
      attachReactionListeners();
      
      document.getElementById('no-results').classList.add('hidden');
      document.getElementById('visible-count').textContent = `${additionalPosts + 1} (mixed)`;
      updateToggleButtonState();
    }
    
    function toggleAILabel() {
      showAILabel = !showAILabel;
      updateToggleButtonState();
      
      document.querySelectorAll('.ai-badge').forEach(badge => {
        badge.classList.toggle('hidden', !showAILabel);
      });
    }
    
    function updateToggleButtonState() {
      const btn = document.getElementById('toggle-ai-label');
      if (btn) {
        btn.classList.toggle('active', showAILabel);
      }
    }

    function createPlaceholderPost(index) {
      const post = document.createElement('article');
      post.className = 'post placeholder-post';
      
      const postId = `placeholder-${index}-${Date.now()}`;
      post.dataset.postId = postId;
      
      const person = placeholderNames[Math.floor(Math.random() * placeholderNames.length)];
      const postText = placeholderPosts[Math.floor(Math.random() * placeholderPosts.length)];
      const time = `${Math.floor(Math.random() * 23) + 1}h`;
      
      const imageId = Math.floor(Math.random() * 1000);
      const hasImage = Math.random() > 0.4;
      
      const imageHtml = hasImage ? `
        <div class="post-media" style="border-radius: 0;">
          <img src="https://picsum.photos/seed/${imageId}/600/400" loading="lazy" style="width: 100%; display: block;">
        </div>
      ` : '';
      
      const eng = {
        likes: Math.floor(Math.random() * 300) + 20,
        comments: Math.floor(Math.random() * 30) + 2,
        shares: Math.floor(Math.random() * 100) + 5
      };
      
      post.innerHTML = `
        <div class="post-header-section">
          <div class="post-header">
            <div class="post-avatar">${person.initials}</div>
            <div class="post-header-info">
              <div class="post-name-row">
                <span class="post-name">${person.name}</span>
              </div>
              <div class="post-meta">
                <span>${person.handle}</span>
                <span>Â·</span>
                <span>${time}</span>
                <span>Â·</span>
                <i class="fas fa-earth-americas"></i>
              </div>
            </div>
            <div class="post-more"><i class="fas fa-ellipsis"></i></div>
          </div>
        </div>
        <div class="post-content">
          <div class="post-text">${postText}</div>
        </div>
        ${imageHtml}
        <div class="post-reactions-bar">
          <div class="post-reactions-count">
            <div class="reaction-icons">
              <div class="reaction-icon like"><i class="fas fa-thumbs-up"></i></div>
            </div>
            <span class="like-count">${eng.likes}</span>
          </div>
          <div class="post-engagement-count"><span class="comment-count">${eng.comments}</span> comments Â· <span class="share-count">${eng.shares}</span> shares</div>
        </div>
        <div class="post-actions">
          <div class="post-action like" data-action="like"><i class="far fa-thumbs-up"></i> <span>Like</span></div>
          <div class="post-action reply" data-action="comment"><i class="far fa-comment"></i> <span>Comment</span></div>
          <div class="post-action repost" data-action="share"><i class="fas fa-share"></i> <span>Share</span></div>
        </div>
      `;
      
      post._postData = {
        postId: postId,
        postType: 'placeholder',
        name: person.name,
        handle: person.handle,
        likes: eng.likes,
        comments: eng.comments,
        shares: eng.shares,
        text: postText
      };
      
      return post;
    }

    function createAIPost(cond) {
      const post = document.createElement('article');
      post.className = 'post ai-post';
      post.dataset.age = cond.age_group;
      post.dataset.gender = cond.gender;
      post.dataset.policy = cond.policy_issue;
      post.dataset.ideology = cond.ideology;
      
      const postId = `ai-${cond.condition_id}-${Date.now()}`;
      post.dataset.postId = postId;
      
      const name = `${cond.gender.charAt(0).toUpperCase() + cond.gender.slice(1)} ${cond.age_group}`;
      const handle = `${cond.ideology.charAt(0).toUpperCase() + cond.ideology.slice(1)} voter`;
      const time = `${Math.floor(Math.random() * 23) + 1}h`;
      const initials = cond.age_group.slice(0, 2) + cond.gender.charAt(0).toUpperCase();
      
      const policyTag = policyHashtags[cond.policy_issue] || cond.policy_issue.replace(/_/g, '');
      const hashtags = `#${cond.ideology} #${policyTag}`;
      const postText = postTemplates[Math.floor(Math.random() * postTemplates.length)]
        .replace('{hashtags}', `<span class="post-hashtag">${hashtags}</span>`);
      
      const randomImage = cond.images[Math.floor(Math.random() * cond.images.length)];
      
      const eng = {
        likes: Math.floor(Math.random() * 800) + 100,
        comments: Math.floor(Math.random() * 80) + 20,
        shares: Math.floor(Math.random() * 400) + 50
      };
      
      const badgeClass = showAILabel ? 'ai-badge' : 'ai-badge hidden';
      
      post.innerHTML = `
        <div class="post-header-section">
          <div class="post-header">
            <div class="post-avatar">${initials}</div>
            <div class="post-header-info">
              <div class="post-name-row">
                <span class="post-name">${name}</span>
                <i class="fas fa-circle-check post-verified"></i>
                <span class="${badgeClass}">AI Generated</span>
              </div>
              <div class="post-meta">
                <span>${handle}</span>
                <span>Â·</span>
                <span>${time}</span>
                <span>Â·</span>
                <i class="fas fa-earth-americas"></i>
              </div>
            </div>
            <div class="post-more"><i class="fas fa-ellipsis"></i></div>
          </div>
        </div>
        <div class="post-content">
          <div class="post-text">${postText}</div>
        </div>
        <div class="post-media" style="border-radius: 0;">
          <img src="../generated_images/${cond.image_dir}/${randomImage}" loading="lazy" style="width: 100%; display: block;">
        </div>
        <div class="post-reactions-bar">
          <div class="post-reactions-count">
            <div class="reaction-icons">
              <div class="reaction-icon like"><i class="fas fa-thumbs-up"></i></div>
            </div>
            <span class="like-count">${eng.likes}</span>
          </div>
          <div class="post-engagement-count"><span class="comment-count">${eng.comments}</span> comments Â· <span class="share-count">${eng.shares}</span> shares</div>
        </div>
        <div class="post-actions">
          <div class="post-action like" data-action="like"><i class="far fa-thumbs-up"></i> <span>Like</span></div>
          <div class="post-action reply" data-action="comment"><i class="far fa-comment"></i> <span>Comment</span></div>
          <div class="post-action repost" data-action="share"><i class="fas fa-share"></i> <span>Share</span></div>
        </div>
      `;
      
      post._postData = {
        postId: postId,
        postType: 'ai',
        conditionId: cond.condition_id,
        ageGroup: cond.age_group,
        gender: cond.gender,
        likes: eng.likes,
        comments: eng.comments,
        shares: eng.shares,
        policyIssue: cond.policy_issue,
        ideology: cond.ideology,
        name: name,
        handle: handle,
        text: postText.replace(/<[^>]*>/g, '')
      };
      
      return post;
    }

    function exitMixedFeed() {
      isMixedFeedMode = false;
      renderPosts();
      applyFilters();
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    document.addEventListener('DOMContentLoaded', loadData);

    // ============================================
    // QUALITY CONTROL MODE
    // ============================================
    
    const QC_CONFIG = {
      googleScriptUrl: 'https://script.google.com/macros/s/AKfycbwOEk-02CPwCnSsovJh3n9F8TAIU0u8Sx1rBQ1ZAZroHOC6TWvlbYtJcu0j2Qk2O5vu9Q/exec'
    };
    
    const REACTIONS_CONFIG = {
      googleScriptUrl: ''
    };
    
    let qcMode = false;
    let qcImages = [];
    let qcCurrentIndex = 0;
    let qcCodedImages = JSON.parse(localStorage.getItem('qc_coded_images') || '{}');
    
    function switchMode(mode) {
      const mainFeed = document.querySelector('.main-feed');
      const qcContainer = document.getElementById('qc-container');
      const expContainer = document.getElementById('experience-container');
      const sidebarRight = document.querySelector('.sidebar-right');
      const sidebarLeft = document.querySelector('.sidebar-left');
      const navHome = document.getElementById('nav-home');
      const navQc = document.getElementById('nav-qc');
      const navExp = document.getElementById('nav-exp');
      const navHomeTop = document.getElementById('nav-home-top');
      const navQcTop = document.getElementById('nav-qc-top');
      const navExpTop = document.getElementById('nav-exp-top');
      const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
      
      // Reset all modes
      qcMode = false;
      mainFeed.classList.add('hidden');
      qcContainer.classList.remove('active');
      expContainer.classList.remove('active');
      sidebarRight.classList.add('hidden');
      sidebarLeft.classList.remove('hidden');
      navHome?.classList.remove('active');
      navQc?.classList.remove('active');
      navExp?.classList.remove('active');
      navHomeTop?.classList.remove('active');
      navQcTop?.classList.remove('active');
      navExpTop?.classList.remove('active');
      
      if (mode === 'qc') {
        qcMode = true;
        qcContainer.classList.add('active');
        navQc?.classList.add('active');
        navQcTop?.classList.add('active');
        mobileNavItems.forEach((item, i) => {
          item.classList.toggle('active', i === 3);
        });
        initQCMode();
      } else if (mode === 'experience') {
        expContainer.classList.add('active');
        sidebarLeft.classList.add('hidden');
        navExp?.classList.add('active');
        navExpTop?.classList.add('active');
        mobileNavItems.forEach((item, i) => {
          item.classList.toggle('active', i === 4);
        });
        initExperienceMode();
      } else {
        // Feed mode
        mainFeed.classList.remove('hidden');
        sidebarRight.classList.remove('hidden');
        navHome?.classList.add('active');
        navHomeTop?.classList.add('active');
        mobileNavItems.forEach((item, i) => {
          item.classList.toggle('active', i === 0);
        });
      }
    }

    // ============================================
    // EXPERIENCE MODE
    // ============================================
    
    let experienceData = {
      gender: null,
      age: null,
      political: 5,
      issue: null
    };

    let debugMode = false;
    let postViewTimes = {}; // { postId: { totalTime, lastEnterTime, author, type } }
    let viewTrackingObserver = null;

    function initExperienceMode() {
      // Reset form
      experienceData = { gender: null, age: null, political: 5, issue: null };
      debugMode = false;
      postViewTimes = {};
      
      document.querySelectorAll('.experience-option').forEach(opt => opt.classList.remove('selected'));
      document.getElementById('political-slider').value = 5;
      updatePoliticalDisplay(5);
      document.getElementById('experience-submit').disabled = true;
      document.getElementById('debug-mode-toggle').checked = false;
      
      // Show survey, hide feed
      document.getElementById('experience-survey').classList.remove('hidden');
      document.getElementById('experience-feed').classList.add('hidden');
      
      // Remove debug mode class
      document.getElementById('experience-feed').classList.remove('debug-mode');
      
      // Stop any existing observer and interval
      if (viewTrackingObserver) {
        viewTrackingObserver.disconnect();
        viewTrackingObserver = null;
      }
      if (viewTimerInterval) {
        clearInterval(viewTimerInterval);
        viewTimerInterval = null;
      }
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      window.removeEventListener('blur', handleWindowBlur);
      window.removeEventListener('focus', handleWindowFocus);
      isPageVisible = true;
      
      // Setup event listeners
      setupExperienceListeners();
    }

    function setupExperienceListeners() {
      // Option buttons
      document.querySelectorAll('.experience-option').forEach(btn => {
        btn.onclick = () => {
          const field = btn.dataset.field;
          const value = btn.dataset.value;
          
          // Deselect siblings
          btn.parentElement.querySelectorAll('.experience-option').forEach(s => s.classList.remove('selected'));
          btn.classList.add('selected');
          
          experienceData[field] = value;
          checkExperienceComplete();
        };
      });
      
      // Political slider
      const slider = document.getElementById('political-slider');
      slider.oninput = () => {
        const val = parseInt(slider.value);
        experienceData.political = val;
        updatePoliticalDisplay(val);
      };
      
      // Submit button
      document.getElementById('experience-submit').onclick = startExperienceFeed;
    }

    function updatePoliticalDisplay(val) {
      const display = document.getElementById('political-value');
      let ideology, label;
      
      if (val <= 4) {
        ideology = 'left';
        label = `Left (${val})`;
      } else if (val >= 6) {
        ideology = 'right';
        label = `Right (${val})`;
      } else {
        ideology = 'neutral';
        label = `Center (${val})`;
      }
      
      display.innerHTML = `<span class="ideology-badge ${ideology}">${label}</span>`;
    }

    function checkExperienceComplete() {
      const complete = experienceData.gender && experienceData.age && experienceData.issue;
      document.getElementById('experience-submit').disabled = !complete;
    }

    function getIdeologyFromPolitical(val) {
      if (val <= 4) return 'left';
      if (val >= 6) return 'right';
      return 'neutral';
    }

    function startExperienceFeed() {
      const ideology = getIdeologyFromPolitical(experienceData.political);
      
      // Check debug mode
      debugMode = document.getElementById('debug-mode-toggle').checked;
      postViewTimes = {};
      
      // Hide survey, show feed
      document.getElementById('experience-survey').classList.add('hidden');
      document.getElementById('experience-feed').classList.remove('hidden');
      
      // Apply debug mode class to feed container (includes button)
      const feedContainer = document.getElementById('experience-feed');
      feedContainer.classList.toggle('debug-mode', debugMode);
      
      // Update profile summary
      const ideologyLabel = ideology === 'left' ? 'Left' : ideology === 'right' ? 'Right' : 'Center';
      const issueLabel = policyDisplayNames[experienceData.issue] || experienceData.issue;
      document.getElementById('experience-profile-summary').textContent = 
        `${experienceData.age} Â· ${experienceData.gender} Â· ${ideologyLabel} Â· ${issueLabel}`;
      
      // Generate feed
      generateExperienceFeed(experienceData.gender, experienceData.age, ideology, experienceData.issue);
      
      // Always start view tracking (display only shows in debug mode)
      startViewTracking();
      
      // Scroll to top of feed
      window.scrollTo({ top: 0, behavior: 'instant' });
      document.getElementById('experience-container').scrollTop = 0;
    }

    // Name pools by age and gender
    const namesByDemo = {
      'female_young': [
        'Emma de Vries', 'Sophie Jansen', 'Lisa Mulder', 'Fleur Hendriks', 'Anna Smit',
        'Julia Bakker', 'Lotte van Dijk', 'Sanne Peters', 'Iris Visser', 'Eva de Boer',
        'Noor Vermeer', 'Luna Meijer', 'Femke Bos', 'Roos de Graaf', 'Amber Willems',
        'Tessa Hoekstra', 'Nina Schouten', 'Merel Dekker', 'Lieke van der Berg', 'Esmee Prins'
      ],
      'female_old': [
        'Johanna van Dijk', 'Maria Bakker', 'Anneke Jansen', 'Gerda Smit', 'Wilhelmina de Vries',
        'Hendrika Peters', 'Cornelia Mulder', 'Geertje Visser', 'Klasina de Boer', 'Dina Meijer',
        'Aaltje Hendriks', 'Grietje van der Berg', 'Jantje Bos', 'Neeltje Dekker', 'Pietje Prins'
      ],
      'male_young': [
        'Thomas Bakker', 'Lars van Dijk', 'Max Visser', 'Daan de Boer', 'Bram Peters',
        'Luuk Jansen', 'Sem Mulder', 'Jesse Hendriks', 'Ruben Smit', 'Tim de Vries',
        'Niels Meijer', 'Stijn van der Berg', 'Rick Bos', 'Thijs Dekker', 'Kevin Prins',
        'Joost Vermeer', 'Martijn Schouten', 'Wouter Hoekstra', 'Bas Willems', 'Jeroen de Graaf'
      ],
      'male_old': [
        'Jan van Dijk', 'Piet Bakker', 'Klaas Jansen', 'Hendrik Smit', 'Willem de Vries',
        'Cornelis Peters', 'Gerrit Mulder', 'Johannes Visser', 'Jacobus de Boer', 'Dirk Meijer',
        'Arie Hendriks', 'Bernardus van der Berg', 'Frederik Bos', 'Albertus Dekker', 'Theodorus Prins'
      ]
    };

    const organizations = [
      { name: 'NOS Nieuws', logoUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d9/NOS_logo.svg/200px-NOS_logo.svg.png', fallbackIcon: 'newspaper', posts: [
        'LIVE: Kamerdebat over de begroting voor volgend jaar. Volg het hier.',
        'Nieuwe cijfers CBS: werkloosheid daalt naar laagste punt in 10 jaar.',
        'Weerbericht: komende dagen wisselvallig met kans op buien.'
      ]},
      { name: 'De Volkskrant', logoUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/bf/De_Volkskrant_logo.svg/200px-De_Volkskrant_logo.svg.png', fallbackIcon: 'newspaper', posts: [
        'Analyse: Wat betekenen de nieuwe klimaatplannen voor Nederlandse huishoudens?',
        'Interview met de nieuwe burgemeester: "We moeten de stad groener maken"',
        'Recensie: Het nieuwe boek van Arnon Grunberg is een meesterwerk.'
      ]},
      { name: 'RTL Nieuws', logoUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4a/RTL_Nederland_logo.svg/200px-RTL_Nederland_logo.svg.png', fallbackIcon: 'tv', posts: [
        'BREAKING: Kabinet presenteert nieuwe maatregelen voor de woningmarkt.',
        'Vanavond in RTL Late Night: gesprek over de toekomst van werk.',
        'Video: Zo ziet de nieuwe snelweg eruit na jaren van verbouwing.'
      ]},
      { name: 'NU.nl', logoUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/Nu.nl_logo.svg/200px-Nu.nl_logo.svg.png', fallbackIcon: 'globe', posts: [
        'Liveblog: Volg hier het laatste nieuws over de stakingen.',
        'Dit zijn de belangrijkste nieuwsfeiten van vandaag.',
        'Quiz: Hoeveel weet jij over de Nederlandse geschiedenis?'
      ]},
      { name: 'NRC', logoUrl: 'https://upload.wikimedia.org/wikipedia/commons/7/71/NRC_logo.svg', fallbackIcon: 'newspaper', posts: [
        'Analyse: De gevolgen van het nieuwe regeringsbeleid voor de middenklasse.',
        'Opinie: Waarom we het klimaatdebat anders moeten voeren.',
        'Boekrecensie: Een verrassende kijk op de Nederlandse geschiedenis.'
      ]},
      { name: 'Gemeente Amsterdam', logoUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6d/Coat_of_arms_of_Amsterdam.svg/200px-Coat_of_arms_of_Amsterdam.svg.png', fallbackIcon: 'landmark', posts: [
        'Reminder: Morgen start de afsluiting van de Amstelveenseweg voor werkzaamheden.',
        'Nieuw initiatief: gratis sportlessen voor jongeren in de zomervakantie.',
        'Doe mee met de buurtschoonmaak dit weekend! Aanmelden via de link.'
      ]},
      { name: 'Rijksoverheid', logoUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/2b/Logo_rijksoverheid.svg/200px-Logo_rijksoverheid.svg.png', fallbackIcon: 'building-columns', posts: [
        'Nieuwe regeling: zo vraag je de energietoeslag aan.',
        'Vanaf 1 januari gelden nieuwe regels voor thuiswerken. Lees meer â',
        'Campagne gestart: samen maken we Nederland verkeersveiliger.'
      ]},
      { name: 'Milieudefensie', logoUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9e/Milieudefensie_logo.svg/200px-Milieudefensie_logo.svg.png', fallbackIcon: 'leaf', posts: [
        'Grote overwinning! Shell moet sneller verduurzamen van de rechter.',
        'Doe mee met onze actie voor schonere lucht in de stad.',
        'Nieuw rapport: zo kunnen we Nederland klimaatneutraal maken.'
      ]},
      { name: 'Woonbond', logoUrl: null, fallbackIcon: 'house', posts: [
        'Petitie: Stop de huurverhogingen! Al 50.000 handtekeningen verzameld.',
        'Tips: Dit zijn je rechten als huurder bij achterstallig onderhoud.',
        'Woondebat in de Tweede Kamer: dit zijn de belangrijkste punten.'
      ]},
      { name: 'FNV', logoUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/06/FNV_logo.svg/200px-FNV_logo.svg.png', fallbackIcon: 'users', posts: [
        'Stakingsoproep: Morgen leggen medewerkers in de zorg het werk neer.',
        'Onderhandelingen CAO vastgelopen. Werkgevers moeten bewegen!',
        'Succesvol: 5% loonsverhoging bereikt na lange onderhandelingen.'
      ]},
      { name: 'Amnesty Nederland', logoUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/ee/Amnesty_International_logo.svg/200px-Amnesty_International_logo.svg.png', fallbackIcon: 'hand-fist', posts: [
        'Urgent: Schrijf een brief voor vrijlating van politieke gevangenen.',
        'Nieuw rapport over mensenrechtenschendingen gepubliceerd.',
        'Bedankt voor jullie steun! Samen vechten we voor rechtvaardigheid.'
      ]},
      { name: 'Consumentenbond', logoUrl: 'https://logo.clearbit.com/consumentenbond.nl', fallbackIcon: 'shield', posts: [
        'Test: Dit is de beste zorgverzekering voor 2024.',
        'Waarschuwing: Let op voor deze phishing-mails!',
        'Vergelijk en bespaar: de beste energieleveranciers van dit moment.'
      ]},
      { name: 'ANWB', logoUrl: 'https://logo.clearbit.com/anwb.nl', fallbackIcon: 'car', posts: [
        'Filevoorspelling: verwacht druk verkeer richting vakantiebestemmingen.',
        'Tip: Zo bereid je je auto voor op de winter.',
        'Nieuwe laadpalen geopend langs de A2. Elektrisch rijden wordt makkelijker!'
      ]},
      { name: 'Greenpeace NL', logoUrl: 'https://logo.clearbit.com/greenpeace.nl', fallbackIcon: 'leaf', posts: [
        'Actie op de Noordzee: bescherm onze oceanen tegen olieboringen!',
        'Goed nieuws: supermarkten stoppen met plastic verpakkingen.',
        'Doe mee: plantdag in het Vondelpark dit weekend.'
      ]},
      { name: 'NRC', logoUrl: 'https://logo.clearbit.com/nrc.nl', fallbackIcon: 'newspaper', posts: [
        'Podcast: Luister naar onze nieuwe serie over de klimaatcrisis.',
        'Opinie: Waarom we het debat over migratie anders moeten voeren.',
        'Fotoserie: De mooiste plekken van Nederland in de herfst.'
      ]},
      { name: 'Trouw', logoUrl: 'https://logo.clearbit.com/trouw.nl', fallbackIcon: 'newspaper', posts: [
        'Duurzaam leven: 10 tips om je ecologische voetafdruk te verkleinen.',
        'Interview: "Geloof speelt nog steeds een belangrijke rol in Nederland"',
        'Reportage: Een dag in het leven van een huisarts op het platteland.'
      ]}
    ];

    let usedAvatarIds = new Set();
    let usedNames = new Set();

    // Avatar ID ranges that tend to have appropriate ages in randomuser.me
    // These are approximate - randomuser.me doesn't guarantee age but certain ranges tend to have older/younger faces
    const avatarRanges = {
      'young': { min: 1, max: 50 },   // IDs 1-50 tend to have younger faces
      'old': { min: 51, max: 99 }      // IDs 51-99 tend to have older faces
    };

    function getUniqueAvatarId() {
      let id;
      do {
        id = Math.floor(Math.random() * 99) + 1;
      } while (usedAvatarIds.has(id) && usedAvatarIds.size < 99);
      usedAvatarIds.add(id);
      return id;
    }

    function getAgeAppropriateAvatarId(age) {
      const isOld = age === '45-59' || age === '60+';
      const range = isOld ? avatarRanges.old : avatarRanges.young;
      
      let id;
      let attempts = 0;
      do {
        id = Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
        attempts++;
      } while (usedAvatarIds.has(id) && attempts < 50);
      
      usedAvatarIds.add(id);
      return id;
    }

    function getUniqueName(gender, age) {
      const isOld = age === '45-59' || age === '60+';
      const key = `${gender}_${isOld ? 'old' : 'young'}`;
      const pool = namesByDemo[key] || namesByDemo['male_young'];
      
      const available = pool.filter(n => !usedNames.has(n));
      if (available.length === 0) {
        // All used, generate a unique one
        return pool[Math.floor(Math.random() * pool.length)] + ' ' + Math.floor(Math.random() * 100);
      }
      const name = available[Math.floor(Math.random() * available.length)];
      usedNames.add(name);
      return name;
    }

    function getUniqueOrg() {
      const available = organizations.filter(o => !usedNames.has(o.name));
      if (available.length === 0) {
        return organizations[Math.floor(Math.random() * organizations.length)];
      }
      const org = available[Math.floor(Math.random() * available.length)];
      usedNames.add(org.name);
      return org;
    }

    function generateExperienceFeed(gender, age, ideology, issue) {
      const container = document.getElementById('experience-posts');
      container.innerHTML = '';
      
      // Reset used trackers
      usedAvatarIds = new Set();
      usedNames = new Set();
      
      const posts = [];
      const totalPosts = 40;
      const aiPostCount = 4;
      
      // Find the tailored condition
      const tailoredCondition = conditionsData.conditions.find(c => 
        c.gender === gender && 
        c.age_group === age && 
        c.ideology === ideology && 
        c.policy_issue === issue
      );
      
      // Get random conditions for the other 3 AI posts (different from tailored)
      const otherConditions = conditionsData.conditions.filter(c => 
        c.images && c.images.length > 0 &&
        !(c.gender === gender && c.age_group === age && c.ideology === ideology && c.policy_issue === issue)
      );
      shuffleArray(otherConditions);
      const randomConditions = otherConditions.slice(0, 3);
      
      // Create placeholder posts
      for (let i = 0; i < totalPosts - aiPostCount; i++) {
        posts.push(createExperiencePlaceholderPost(i, gender, age));
      }
      
      // Create AI posts
      if (tailoredCondition && tailoredCondition.images && tailoredCondition.images.length > 0) {
        posts.push(createExperienceAIPost(tailoredCondition, true, gender, age));
      }
      
      randomConditions.forEach(cond => {
        if (cond.images && cond.images.length > 0) {
          posts.push(createExperienceAIPost(cond, false, gender, age));
        }
      });
      
      // Shuffle posts
      shuffleArray(posts);
      
      // Add to container
      posts.forEach(post => container.appendChild(post));
      
      // Initialize carousels and interactions
      initExperienceCarousels();
      attachExperienceInteractions();
    }

    function createExperiencePlaceholderPost(index, userGender, userAge) {
      const post = document.createElement('article');
      post.className = 'post placeholder-post';
      post.dataset.postId = `placeholder-${index}-${Date.now()}`;
      
      const time = `${Math.floor(Math.random() * 23) + 1}h`;
      
      const hasImage = Math.random() > 0.4;
      const imageId = Math.floor(Math.random() * 1000);
      const likes = Math.floor(Math.random() * 200) + 5;
      const comments = Math.floor(Math.random() * 30);
      const shares = Math.floor(Math.random() * 15);
      
      // Decide if this is a person or organization (20% chance org)
      const isOrg = Math.random() < 0.2;
      
      let avatarHtml, authorName, authorSub, postText;
      
      if (isOrg) {
        const org = getUniqueOrg();
        authorName = org.name;
        authorSub = '';
        // Use organization-specific post content
        postText = org.posts[Math.floor(Math.random() * org.posts.length)];
        if (org.logoUrl) {
          avatarHtml = `<div class="avatar-wrapper"><img class="post-avatar-img org-logo" src="${org.logoUrl}" alt="${org.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="post-avatar org-avatar" style="display:none;"><i class="fas fa-${org.fallbackIcon}"></i></div></div>`;
        } else {
          avatarHtml = `<div class="avatar-wrapper"><div class="post-avatar org-avatar"><i class="fas fa-${org.fallbackIcon}"></i></div></div>`;
        }
      } else {
        // Mix of genders for realistic feed
        const postGender = Math.random() > 0.5 ? 'female' : 'male';
        const postAge = ['18-29', '30-44', '45-59', '60+'][Math.floor(Math.random() * 4)];
        authorName = getUniqueName(postGender, postAge);
        authorSub = '';
        // Use personal placeholder posts
        postText = placeholderPosts[Math.floor(Math.random() * placeholderPosts.length)];
        
        const avatarId = getAgeAppropriateAvatarId(postAge);
        const avatarGender = postGender === 'female' ? 'women' : 'men';
        const initials = authorName.split(' ').map(n=>n[0]).join('');
        const fallbackColor = `hsl(${Math.floor(Math.random()*360)}, 70%, 60%)`;
        avatarHtml = `<div class="avatar-wrapper"><img class="post-avatar-img" src="https://randomuser.me/api/portraits/${avatarGender}/${avatarId}.jpg" alt="${authorName}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="post-avatar" style="display:none; background:${fallbackColor};">${initials}</div></div>`;
      }
      
      post.innerHTML = `
        <div class="post-header">
          ${avatarHtml}
          <div class="post-meta">
            <div class="post-author">${authorName}</div>
            <div class="post-info">${time} Â· <i class="fas fa-earth-americas"></i></div>
          </div>
          <button class="post-options"><i class="fas fa-ellipsis"></i></button>
        </div>
        <div class="post-content">${postText}</div>
        ${hasImage ? `
          <div class="post-image-container" style="position: relative;">
            <div class="post-view-timer">â± 0s</div>
            <img src="https://picsum.photos/seed/${imageId}/600/400" alt="Post image" class="post-single-image">
          </div>
        ` : '<div style="position: relative;"><div class="post-view-timer">â± 0s</div></div>'}
        <div class="post-stats">
          <div class="post-reactions-count">
            <span class="reaction-icons"><i class="fas fa-thumbs-up"></i></span>
            <span class="like-count">${likes}</span>
          </div>
          <div class="post-comments-count">${comments} ${comments === 1 ? 'comment' : 'comments'}${shares > 0 ? ` Â· ${shares} ${shares === 1 ? 'share' : 'shares'}` : ''}</div>
        </div>
        <div class="post-divider"></div>
        <div class="post-actions">
          <button class="post-action like-btn" data-liked="false"><i class="far fa-thumbs-up"></i> Like</button>
          <button class="post-action comment-btn"><i class="far fa-comment"></i> Comment</button>
          <button class="post-action share-btn"><i class="far fa-share-square"></i> Share</button>
        </div>
      `;
      
      return post;
    }

    function createExperienceAIPost(condition, isTailored, userGender, userAge) {
      const post = document.createElement('article');
      post.className = 'post ai-post';
      post.dataset.postId = `ai-${condition.condition_id}-${Date.now()}`;
      post.dataset.isTailored = isTailored;
      post.dataset.conditionId = condition.condition_id;
      
      const images = condition.images;
      const randomImage = images[Math.floor(Math.random() * images.length)];
      const imagePath = `../generated_images/${condition.condition_id}/${randomImage}`;
      
      const policyTag = policyHashtags[condition.policy_issue] || condition.policy_issue.replace(/_/g, '');
      const time = `${Math.floor(Math.random() * 12) + 1}h`;
      const likes = Math.floor(Math.random() * 500) + 100;
      const comments = Math.floor(Math.random() * 80) + 10;
      const shares = Math.floor(Math.random() * 30) + 5;
      
      // AI posts always come from people matching the condition's demographic
      const postGender = condition.gender;
      const postAge = condition.age_group;
      const authorName = getUniqueName(postGender, postAge);
      
      // Get age-appropriate avatar ID
      const avatarId = getAgeAppropriateAvatarId(postAge);
      const avatarGender = postGender === 'female' ? 'women' : 'men';
      const initials = authorName.split(' ').map(n=>n[0]).join('');
      const fallbackColor = `hsl(${Math.floor(Math.random()*360)}, 70%, 60%)`;
      const avatarHtml = `<div class="avatar-wrapper"><img class="post-avatar-img" src="https://randomuser.me/api/portraits/${avatarGender}/${avatarId}.jpg" alt="${authorName}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="post-avatar" style="display:none; background:${fallbackColor};">${initials}</div></div>`;
      
      const postTexts = [
        `Dit moet stoppen. Tijd voor verandering! #${policyTag}`,
        `Wanneer gaan we dit serieus nemen? #${policyTag}`,
        `Kijk hier eens naar... #${policyTag}`,
        `Dit is waar het om gaat. #${policyTag}`,
        `Denk hier eens over na. #${policyTag}`,
        `Deel dit met iedereen! #${policyTag}`,
        `Wij accepteren dit niet langer. #${policyTag}`,
        `Samen staan we sterk. #${policyTag}`
      ];
      const postText = postTexts[Math.floor(Math.random() * postTexts.length)];
      
      post.innerHTML = `
        <div class="post-header">
          ${avatarHtml}
          <div class="post-meta">
            <div class="post-author">${authorName}</div>
            <div class="post-info">${time} Â· <i class="fas fa-earth-americas"></i></div>
          </div>
          <button class="post-options"><i class="fas fa-ellipsis"></i></button>
        </div>
        <div class="post-content">${postText}</div>
        <div class="post-image-container" style="position: relative;">
          <div class="post-view-timer">â± 0s</div>
          <div class="experience-ai-indicator ${isTailored ? 'tailored' : ''}">
            ${isTailored ? 'â¨ Tailored' : 'ð² Random'}<br>
            <small>${condition.age_group} ${condition.gender}<br>${policyDisplayNames[condition.policy_issue] || condition.policy_issue}<br>${condition.ideology}</small>
          </div>
          <img src="${imagePath}" alt="Post image" class="post-single-image" 
               onerror="this.src='https://picsum.photos/seed/${Math.floor(Math.random()*10000)}/600/400'">
        </div>
        <div class="post-stats">
          <div class="post-reactions-count">
            <span class="reaction-icons"><i class="fas fa-thumbs-up"></i><i class="fas fa-heart"></i></span>
            <span class="like-count">${likes}</span>
          </div>
          <div class="post-comments-count">${comments} ${comments === 1 ? 'comment' : 'comments'} Â· ${shares} ${shares === 1 ? 'share' : 'shares'}</div>
        </div>
        <div class="post-divider"></div>
        <div class="post-actions">
          <button class="post-action like-btn" data-liked="false"><i class="far fa-thumbs-up"></i> Like</button>
          <button class="post-action comment-btn"><i class="far fa-comment"></i> Comment</button>
          <button class="post-action share-btn"><i class="far fa-share-square"></i> Share</button>
        </div>
      `;
      
      return post;
    }

    function initExperienceCarousels() {
      // Simple init for any carousels in experience mode
    }

    function attachExperienceInteractions() {
      const container = document.getElementById('experience-posts');
      
      // Like buttons
      container.querySelectorAll('.like-btn').forEach(btn => {
        btn.onclick = function() {
          const isLiked = this.dataset.liked === 'true';
          const post = this.closest('.post');
          const countEl = post.querySelector('.like-count');
          let count = parseInt(countEl.textContent);
          
          if (isLiked) {
            this.dataset.liked = 'false';
            this.innerHTML = '<i class="far fa-thumbs-up"></i> Like';
            this.classList.remove('liked');
            countEl.textContent = count - 1;
          } else {
            this.dataset.liked = 'true';
            this.innerHTML = '<i class="fas fa-thumbs-up"></i> Liked';
            this.classList.add('liked');
            countEl.textContent = count + 1;
            
            // Add animation
            this.style.transform = 'scale(1.1)';
            setTimeout(() => this.style.transform = '', 150);
          }
        };
      });
      
      // Comment buttons
      container.querySelectorAll('.comment-btn').forEach(btn => {
        btn.onclick = function() {
          const post = this.closest('.post');
          
          // Check if comment box already exists
          if (post.querySelector('.comment-input-box')) {
            post.querySelector('.comment-input-box').remove();
            return;
          }
          
          const commentBox = document.createElement('div');
          commentBox.className = 'comment-input-box';
          commentBox.innerHTML = `
            <div class="comment-input-wrapper">
              <input type="text" placeholder="Write a comment..." class="comment-input">
              <button class="comment-send"><i class="fas fa-paper-plane"></i></button>
            </div>
          `;
          
          post.appendChild(commentBox);
          
          const input = commentBox.querySelector('.comment-input');
          const sendBtn = commentBox.querySelector('.comment-send');
          
          input.focus();
          
          sendBtn.onclick = () => {
            if (input.value.trim()) {
              // Update comment count
              const statsEl = post.querySelector('.post-comments-count');
              const match = statsEl.textContent.match(/(\d+)\s*comments?/);
              if (match) {
                const newCount = parseInt(match[1]) + 1;
                statsEl.textContent = statsEl.textContent.replace(/\d+\s*comments?/, `${newCount} comments`);
              }
              
              // Show "comment posted" feedback
              commentBox.innerHTML = '<div class="comment-posted"><i class="fas fa-check"></i> Comment posted</div>';
              setTimeout(() => commentBox.remove(), 1500);
            }
          };
          
          input.onkeydown = (e) => {
            if (e.key === 'Enter') sendBtn.click();
          };
        };
      });
      
      // Share buttons
      container.querySelectorAll('.share-btn').forEach(btn => {
        btn.onclick = function() {
          if (this.classList.contains('shared')) return; // Already shared
          
          const post = this.closest('.post');
          
          // Update share count
          const statsEl = post.querySelector('.post-comments-count');
          const shareMatch = statsEl.textContent.match(/(\d+)\s*shares?/);
          if (shareMatch) {
            const newCount = parseInt(shareMatch[1]) + 1;
            statsEl.textContent = statsEl.textContent.replace(/\d+\s*shares?/, `${newCount} shares`);
          } else {
            // Add share count if not present
            statsEl.textContent += ' Â· 1 share';
          }
          
          // Show share feedback
          const feedback = document.createElement('div');
          feedback.className = 'share-feedback';
          feedback.innerHTML = '<i class="fas fa-share"></i> Shared to your timeline';
          post.appendChild(feedback);
          
          this.innerHTML = '<i class="fas fa-share-square"></i> Shared';
          this.classList.add('shared');
          
          setTimeout(() => feedback.remove(), 2000);
        };
      });
    }

    function resetExperience() {
      initExperienceMode();
    }

    let isPageVisible = true;
    let viewTimerInterval = null;

    function startViewTracking() {
      const posts = document.querySelectorAll('#experience-posts .post');
      
      viewTrackingObserver = new IntersectionObserver((entries) => {
        // Don't track if page is not visible
        if (!isPageVisible) return;
        
        entries.forEach(entry => {
          const postId = entry.target.dataset.postId;
          if (!postId) return;
          
          if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
            // Post is visible - start timing
            if (!postViewTimes[postId]) {
              const author = entry.target.querySelector('.post-author')?.textContent || 'Unknown';
              const isAI = entry.target.classList.contains('ai-post');
              const isTailored = entry.target.dataset.isTailored === 'true';
              postViewTimes[postId] = {
                totalTime: 0,
                lastEnterTime: Date.now(),
                author: author,
                type: isAI ? (isTailored ? 'ai-tailored' : 'ai-random') : 'regular',
                isCurrentlyVisible: true
              };
            } else if (!postViewTimes[postId].lastEnterTime) {
              postViewTimes[postId].lastEnterTime = Date.now();
              postViewTimes[postId].isCurrentlyVisible = true;
            }
          } else {
            // Post left view - add elapsed time
            if (postViewTimes[postId] && postViewTimes[postId].lastEnterTime) {
              postViewTimes[postId].totalTime += Date.now() - postViewTimes[postId].lastEnterTime;
              postViewTimes[postId].lastEnterTime = null;
              postViewTimes[postId].isCurrentlyVisible = false;
            }
          }
        });
        
        // Update timer displays
        updateViewTimers();
      }, {
        threshold: 0.5
      });
      
      posts.forEach(post => {
        viewTrackingObserver.observe(post);
      });
      
      // Update timers every second
      viewTimerInterval = setInterval(updateViewTimers, 1000);
      
      // Listen for page visibility changes (tab switch, minimize)
      document.addEventListener('visibilitychange', handleVisibilityChange);
      
      // Also listen for window blur/focus (switching apps, more reliable backup)
      window.addEventListener('blur', handleWindowBlur);
      window.addEventListener('focus', handleWindowFocus);
    }

    function handleVisibilityChange() {
      if (document.hidden) {
        pauseAllTimers();
      } else {
        resumeVisibleTimers();
      }
    }

    function handleWindowBlur() {
      // Window lost focus (switched to another app)
      pauseAllTimers();
    }

    function handleWindowFocus() {
      // Window gained focus
      // Only resume if document is also visible (not hidden)
      if (!document.hidden) {
        resumeVisibleTimers();
      }
    }

    function pauseAllTimers() {
      if (!isPageVisible) return; // Already paused
      
      isPageVisible = false;
      const now = Date.now();
      
      Object.keys(postViewTimes).forEach(postId => {
        if (postViewTimes[postId].lastEnterTime) {
          postViewTimes[postId].totalTime += now - postViewTimes[postId].lastEnterTime;
          postViewTimes[postId].lastEnterTime = null;
        }
      });
      
      updateViewTimers();
    }

    function resumeVisibleTimers() {
      if (isPageVisible) return; // Already running
      
      isPageVisible = true;
      const now = Date.now();
      
      Object.keys(postViewTimes).forEach(postId => {
        if (postViewTimes[postId].isCurrentlyVisible && !postViewTimes[postId].lastEnterTime) {
          postViewTimes[postId].lastEnterTime = now;
        }
      });
      
      updateViewTimers();
    }

    function updateViewTimers() {
      const now = Date.now();
      Object.keys(postViewTimes).forEach(postId => {
        const data = postViewTimes[postId];
        let currentTime = data.totalTime;
        if (data.lastEnterTime) {
          currentTime += now - data.lastEnterTime;
        }
        
        const seconds = Math.floor(currentTime / 1000);
        const timerEl = document.querySelector(`[data-post-id="${postId}"] .post-view-timer`);
        if (timerEl) {
          timerEl.textContent = `â± ${seconds}s`;
        }
      });
    }

    function showResults() {
      // Finalize current view times
      const now = Date.now();
      Object.keys(postViewTimes).forEach(postId => {
        if (postViewTimes[postId].lastEnterTime) {
          postViewTimes[postId].totalTime += now - postViewTimes[postId].lastEnterTime;
          postViewTimes[postId].lastEnterTime = null;
        }
      });
      
      // Sort by view time
      const sorted = Object.entries(postViewTimes)
        .map(([postId, data]) => ({ postId, ...data }))
        .sort((a, b) => b.totalTime - a.totalTime)
        .slice(0, 5);
      
      // Build results HTML
      const resultsContent = document.getElementById('results-content');
      if (sorted.length === 0) {
        resultsContent.innerHTML = '<p style="text-align: center; color: var(--circl-text-secondary);">No viewing data recorded yet. Scroll through the feed first!</p>';
      } else {
        resultsContent.innerHTML = sorted.map((item, i) => {
          const seconds = (item.totalTime / 1000).toFixed(1);
          const typeLabel = item.type === 'ai-tailored' ? 'â¨ AI - Tailored to you' :
                           item.type === 'ai-random' ? 'ð² AI - Random' : 'Regular post';
          const typeClass = item.type;
          
          return `
            <div class="results-item">
              <div class="results-rank">${i + 1}</div>
              <div class="results-info">
                <div class="results-author">${item.author}</div>
                <div class="results-type ${typeClass}">${typeLabel}</div>
              </div>
              <div class="results-time">${seconds}<small>s</small></div>
            </div>
          `;
        }).join('');
      }
      
      document.getElementById('results-modal').classList.add('active');
    }

    function closeResults() {
      document.getElementById('results-modal').classList.remove('active');
    }

    let experienceShowLabels = false;

    function toggleExperienceLabels() {
      experienceShowLabels = !experienceShowLabels;
      const btn = document.getElementById('experience-toggle-labels');
      const container = document.getElementById('experience-posts');
      
      btn.classList.toggle('active', experienceShowLabels);
      btn.innerHTML = experienceShowLabels 
        ? '<i class="fas fa-eye-slash"></i><span>Hide AI</span>'
        : '<i class="fas fa-eye"></i><span>Show AI</span>';
      
      container.classList.toggle('show-ai-labels', experienceShowLabels);
    }
    
    function initQCMode() {
      const savedCoderId = localStorage.getItem('qc_coder_id') || '';
      document.getElementById('qc-coder-id').value = savedCoderId;
      buildQCImageList();
      setupQCEventListeners();
      showQCImage(0);
    }
    
    function buildQCImageList() {
      qcImages = [];
      const showUncodedOnly = document.getElementById('qc-uncoded-only').checked;
      
      conditionsData.conditions.forEach(cond => {
        cond.images.forEach(img => {
          const imageId = `${cond.condition_id}/${img}`;
          const isCoded = qcCodedImages[imageId];
          
          if (!showUncodedOnly || !isCoded) {
            qcImages.push({
              condition: cond,
              image: img,
              imageId: imageId,
              isCoded: isCoded
            });
          }
        });
      });
      
      updateQCProgress();
    }
    
    function setupQCEventListeners() {
      document.getElementById('qc-coder-id').addEventListener('change', (e) => {
        localStorage.setItem('qc_coder_id', e.target.value);
      });
      
      document.getElementById('qc-uncoded-only').addEventListener('change', () => {
        buildQCImageList();
        showQCImage(0);
      });
      
      const starContainer = document.getElementById('qc-star-rating');
      const stars = document.querySelectorAll('.qc-star');
      
      stars.forEach(star => {
        star.addEventListener('click', (e) => {
          const value = parseInt(e.target.dataset.value);
          document.getElementById('image_quality').value = value;
          updateStars(value);
        });
        
        star.addEventListener('mouseenter', (e) => {
          const hoverValue = parseInt(e.target.dataset.value);
          highlightStars(hoverValue);
        });
      });
      
      starContainer.addEventListener('mouseleave', () => {
        const currentValue = parseInt(document.getElementById('image_quality').value) || 0;
        highlightStars(currentValue);
      });
      
      document.getElementById('emotional_intensity').addEventListener('input', (e) => {
        document.getElementById('intensity-value').textContent = e.target.value;
      });
      
      document.addEventListener('keydown', (e) => {
        if (!qcMode) return;
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        if (e.key === 'ArrowLeft') qcNavigate(-1);
        if (e.key === 'ArrowRight') qcNavigate(1);
      });
    }
    
    function updateStars(value) {
      document.querySelectorAll('.qc-star').forEach(star => {
        const starValue = parseInt(star.dataset.value);
        star.classList.toggle('active', starValue <= value);
      });
    }
    
    function highlightStars(value) {
      document.querySelectorAll('.qc-star').forEach(star => {
        const starValue = parseInt(star.dataset.value);
        star.classList.toggle('hover', starValue <= value);
        const currentValue = parseInt(document.getElementById('image_quality').value) || 0;
        star.classList.toggle('active', starValue <= currentValue);
      });
    }
    
    function getOutgroup(ideology) {
      const outgroupMap = {
        'left': 'Right-Wingers',
        'right': 'Left-Wingers',
        'neutral': 'Extremists'
      };
      return outgroupMap[ideology] || 'Unknown';
    }

    function showQCImage(index) {
      if (qcImages.length === 0) {
        document.getElementById('qc-image').src = '';
        document.getElementById('qc-counter').textContent = 'No images';
        document.getElementById('qc-condition-info').innerHTML = '<span class="qc-condition-tag">No images to display</span>';
        return;
      }
      
      qcCurrentIndex = Math.max(0, Math.min(index, qcImages.length - 1));
      const item = qcImages[qcCurrentIndex];
      
      document.getElementById('qc-image').src = `../generated_images/${item.condition.image_dir}/${item.image}`;
      document.getElementById('qc-counter').textContent = `${qcCurrentIndex + 1} / ${qcImages.length}`;
      
      const outgroup = getOutgroup(item.condition.ideology);
      
      const condInfo = document.getElementById('qc-condition-info');
      const policyName = policyDisplayNames[item.condition.policy_issue] || item.condition.policy_issue.replace(/_/g, ' ');
      condInfo.innerHTML = `
        <span class="qc-condition-tag highlight">${item.condition.age_group}</span>
        <span class="qc-condition-tag highlight">${item.condition.gender}</span>
        <span class="qc-condition-tag">${policyName}</span>
        <span class="qc-condition-tag ideology-tag ${item.condition.ideology}">${item.condition.ideology}</span>
        <span class="qc-condition-tag outgroup-tag">Outgroup: ${outgroup}</span>
        ${item.isCoded ? '<span class="qc-coded-badge"><i class="fas fa-check"></i> Coded</span>' : ''}
      `;
      
      document.getElementById('qc-prev').disabled = qcCurrentIndex === 0;
      document.getElementById('qc-next').disabled = qcCurrentIndex === qcImages.length - 1;
      
      resetQCForm();
      updateQCProgress();
    }
    
    function qcNavigate(direction) {
      showQCImage(qcCurrentIndex + direction);
    }
    
    function updateQCProgress() {
      const totalImages = conditionsData ? 
        conditionsData.conditions.reduce((sum, c) => sum + c.images.length, 0) : 0;
      const codedCount = Object.keys(qcCodedImages).length;
      
      document.getElementById('qc-progress').textContent = 
        `${codedCount} of ${totalImages} coded`;
    }
    
    function resetQCForm() {
      const form = document.getElementById('qc-form');
      form.reset();
      document.getElementById('image_quality').value = '0';
      updateStars(0);
      document.getElementById('intensity-value').textContent = '5';
      document.getElementById('qc-status').textContent = '';
      document.getElementById('qc-status').className = 'qc-status';
    }
    
    async function submitQCForm(event) {
      event.preventDefault();
      
      const coderId = document.getElementById('qc-coder-id').value.trim();
      if (!coderId) {
        showQCStatus('Please enter your Coder ID', 'error');
        return;
      }
      
      const imageQuality = parseInt(document.getElementById('image_quality').value);
      if (imageQuality === 0) {
        showQCStatus('Please rate the image quality (stars)', 'error');
        return;
      }
      
      const form = document.getElementById('qc-form');
      const formData = new FormData(form);
      const item = qcImages[qcCurrentIndex];
      
      const data = {
        timestamp: new Date().toISOString(),
        coder_id: coderId,
        condition_id: item.condition.condition_id,
        image_filename: item.image,
        no_weird_text: formData.get('no_weird_text'),
        outgroup_present: formData.get('outgroup_present'),
        looks_authentic: formData.get('looks_authentic'),
        age_accurate: formData.get('age_accurate'),
        gender_accurate: formData.get('gender_accurate'),
        suitable: formData.get('suitable'),
        image_quality: imageQuality,
        emotional_intensity: parseInt(formData.get('emotional_intensity')),
        emotional_valence: formData.get('emotional_valence'),
        notes: formData.get('notes') || ''
      };
      
      const submitBtn = document.getElementById('qc-submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
      
      try {
        if (QC_CONFIG.googleScriptUrl) {
          await fetch(QC_CONFIG.googleScriptUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
        
        qcCodedImages[item.imageId] = {
          coderId: coderId,
          timestamp: data.timestamp
        };
        localStorage.setItem('qc_coded_images', JSON.stringify(qcCodedImages));
        
        item.isCoded = true;
        
        showQCStatus('Saved successfully!', 'success');
        
        setTimeout(() => {
          if (qcCurrentIndex < qcImages.length - 1) {
            qcNavigate(1);
          } else {
            showQCStatus('All images in current set have been coded!', 'success');
          }
        }, 500);
        
      } catch (error) {
        console.error('Error submitting:', error);
        showQCStatus('Error saving. Data saved locally.', 'error');
        
        qcCodedImages[item.imageId] = {
          coderId: coderId,
          timestamp: data.timestamp,
          data: data
        };
        localStorage.setItem('qc_coded_images', JSON.stringify(qcCodedImages));
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Submit & Next';
        updateQCProgress();
      }
    }
    
    function showQCStatus(message, type) {
      const status = document.getElementById('qc-status');
      status.textContent = message;
      status.className = `qc-status ${type}`;
    }
    
    function exportQCData() {
      const data = JSON.stringify(qcCodedImages, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `qc_data_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    }

    // ============================================
    // REACTION TRACKING (MIXED FEED MODE)
    // ============================================
    
    let currentCommentPostId = null;
    let currentCommentPostData = null;
    
    function attachReactionListeners() {
      document.querySelectorAll('.post-action[data-action]').forEach(actionBtn => {
        const action = actionBtn.dataset.action;
        const post = actionBtn.closest('.post');
        
        if (!post || !post._postData) return;
        
        // Remove existing listeners by cloning
        const newBtn = actionBtn.cloneNode(true);
        actionBtn.parentNode.replaceChild(newBtn, actionBtn);
        
        newBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          handleReaction(post, action, newBtn);
        });
      });
    }
    
    function handleReaction(post, reactionType, btn) {
      if (!post._postData) return;
      
      const postData = post._postData;
      
      if (reactionType === 'comment') {
        showCommentModal(postData.postId, postData);
      } else if (reactionType === 'like') {
        updateButtonState(post, 'like');
        updateLikeCount(post);
      } else if (reactionType === 'share') {
        updateButtonState(post, 'share');
        updateShareCount(post);
      }
    }
    
    function updateLikeCount(post) {
      const likeCountEl = post.querySelector('.like-count');
      const actionBtn = post.querySelector('[data-action="like"]');
      if (likeCountEl && post._postData) {
        if (actionBtn.classList.contains('liked')) {
          post._postData.likes++;
        } else {
          post._postData.likes--;
        }
        likeCountEl.textContent = post._postData.likes;
      }
    }
    
    function updateShareCount(post) {
      const shareCountEl = post.querySelector('.share-count');
      const actionBtn = post.querySelector('[data-action="share"]');
      if (shareCountEl && post._postData) {
        if (actionBtn.classList.contains('shared')) {
          post._postData.shares++;
          showReactionStatus('Post shared!', 'success');
        } else {
          post._postData.shares--;
          showReactionStatus('Share removed', 'success');
        }
        shareCountEl.textContent = post._postData.shares;
      }
    }
    
    function updateButtonState(post, reactionType) {
      const actionBtn = post.querySelector(`[data-action="${reactionType}"]`);
      if (!actionBtn) return;
      
      if (reactionType === 'like') {
        actionBtn.classList.toggle('liked');
        const icon = actionBtn.querySelector('i');
        if (actionBtn.classList.contains('liked')) {
          icon.classList.remove('far');
          icon.classList.add('fas');
        } else {
          icon.classList.remove('fas');
          icon.classList.add('far');
        }
      } else if (reactionType === 'share') {
        actionBtn.classList.toggle('shared');
      }
    }
    
    function showCommentModal(postId, postData) {
      currentCommentPostId = postId;
      currentCommentPostData = postData;
      
      const modal = document.getElementById('comment-modal-overlay');
      const preview = document.getElementById('comment-post-preview');
      const textarea = document.getElementById('comment-textarea');
      
      const escapeHtml = (text) => {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      };
      
      const previewHtml = `
        <div class="comment-post-preview-header">
          <span class="comment-post-preview-name">${escapeHtml(postData.name)}</span>
          <span class="comment-post-preview-handle">${escapeHtml(postData.handle)}</span>
        </div>
        <div class="comment-post-preview-text">${escapeHtml(postData.text)}</div>
      `;
      
      preview.innerHTML = previewHtml;
      textarea.value = '';
      
      modal.classList.add('active');
      textarea.focus();
      
      const overlayClickHandler = function(e) {
        if (e.target === modal) {
          hideCommentModal();
          modal.removeEventListener('click', overlayClickHandler);
        }
      };
      modal.addEventListener('click', overlayClickHandler);
      
      const keyboardHandler = function(e) {
        if (e.key === 'Escape') {
          hideCommentModal();
          document.removeEventListener('keydown', keyboardHandler);
        } else if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          submitComment();
        }
      };
      document.addEventListener('keydown', keyboardHandler);
    }
    
    function hideCommentModal() {
      const modal = document.getElementById('comment-modal-overlay');
      modal.classList.remove('active');
      currentCommentPostId = null;
      currentCommentPostData = null;
      
      const textarea = document.getElementById('comment-textarea');
      if (textarea) textarea.value = '';
    }
    
    function submitComment() {
      const textarea = document.getElementById('comment-textarea');
      const commentText = textarea.value.trim();
      const submitBtn = document.querySelector('.comment-btn-submit');
      
      if (!commentText) {
        showReactionStatus('Please enter a comment', 'error');
        return;
      }
      
      if (!currentCommentPostId || !currentCommentPostData) {
        showReactionStatus('Error: Post data not found', 'error');
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
      
      // Update comment count on the post
      const post = document.querySelector(`[data-post-id="${currentCommentPostId}"]`);
      if (post && post._postData) {
        post._postData.comments++;
        const commentCountEl = post.querySelector('.comment-count');
        if (commentCountEl) {
          commentCountEl.textContent = post._postData.comments;
        }
      }
      
      hideCommentModal();
      showReactionStatus('Comment posted!', 'success');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Comment';
    }
    
    function trackReaction(postId, reactionType, commentText) {
      if (!isMixedFeedMode) {
        console.warn('Reaction tracking only works in mixed feed mode');
        return Promise.resolve();
      }
      
      const post = document.querySelector(`[data-post-id="${postId}"]`);
      if (!post || !post._postData) {
        console.error('Post not found:', postId);
        return Promise.reject('Post not found');
      }
      
      const postData = post._postData;
      
      const reactionData = {
        timestamp: new Date().toISOString(),
        post_id: postId,
        post_type: postData.postType,
        reaction_type: reactionType,
        comment_text: commentText || ''
      };
      
      if (postData.postType === 'ai') {
        reactionData.condition_id = postData.conditionId;
        reactionData.age_group = postData.ageGroup;
        reactionData.gender = postData.gender;
        reactionData.policy_issue = postData.policyIssue;
        reactionData.ideology = postData.ideology;
      }
      
      return sendReactionToSheets(reactionData);
    }
    
    async function sendReactionToSheets(reactionData) {
      if (!REACTIONS_CONFIG.googleScriptUrl) {
        console.warn('Google Sheets URL not configured for reactions');
        return Promise.resolve();
      }
      
      try {
        await fetch(REACTIONS_CONFIG.googleScriptUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(reactionData)
        });
        return Promise.resolve();
      } catch (error) {
        console.error('Error sending reaction to Google Sheets:', error);
        return Promise.resolve();
      }
    }
    
    function showReactionStatus(message, type = 'success') {
      const status = document.getElementById('reaction-status');
      status.textContent = message;
      status.className = `reaction-status active ${type}`;
      
      setTimeout(() => {
        status.classList.remove('active');
      }, 3000);
    }
  </script>
</body>
</html>
